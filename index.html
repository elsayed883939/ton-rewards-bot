<!DOCTYPE html>
<html lang="ar">
<head>
    <meta name='admaven-placement' content='Bqja6qdC7'>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TON Rewards</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- SDK ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ -->
    <script src="//libtl.com/sdk.js" data-zone="10058786" data-sdk="show_10058786" async></script>
    
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #0088cc;
            --secondary-color: #00bcd4;
            --accent-color: #ff9800;
            --background-light: #f0f8ff;
            --surface-light: #ffffff;
            --text-primary-light: #1a237e;
            --text-secondary-light: #546e7a;
            --border-light: #bbdefb;
            --background-dark: #0a1a2a;
            --surface-dark: #1a2b3c;
            --text-primary-dark: #e3f2fd;
            --text-secondary-dark: #90a4ae;
            --border-dark: #37474f;
            --success: #4caf50;
            --danger: #f44336;
            --pending: #ff9800;
            --ship-gold: #ffd700;
            --ship-silver: #c0c0c0;
            --ocean-blue: #006994;
            --deck-wood: #8b4513;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: var(--font-family); 
            transition: background-color 0.3s, color 0.3s; 
            -webkit-font-smoothing: antialiased;
            background: linear-gradient(135deg, var(--background-dark) 0%, #0a2a3a 100%);
            color: var(--text-primary-dark);
            overflow-x: hidden;
        }

        .ship-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(to bottom, #0a1a2a 0%, #0a2a3a 50%, #0a3a4a 100%);
            box-shadow: 0 0 30px rgba(0, 100, 200, 0.3);
            overflow: hidden;
        }

        .ship-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, var(--deck-wood) 0%, #6b3300 100%);
            z-index: 1;
            border-bottom: 3px solid var(--ship-gold);
        }

        .ship-container::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, var(--deck-wood) 0%, #6b3300 100%);
            z-index: 1;
            border-top: 3px solid var(--ship-gold);
        }

        .wave {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 100%;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" fill="%23006994"><path d="M0,64L80,58.7C160,53,320,43,480,48C640,53,800,75,960,74.7C1120,75,1280,53,1360,42.7L1440,32L1440,120L1360,120C1280,120,1120,120,960,120C800,120,640,120,480,120C320,120,160,120,80,120L0,120Z"></path></svg>');
            background-size: cover;
            opacity: 0.6;
            z-index: 0;
        }

        .wave-2 {
            bottom: 70px;
            height: 15px;
            opacity: 0.4;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" fill="%230088cc"><path d="M0,96L80,90.7C160,85,320,75,480,80C640,85,800,107,960,106.7C1120,107,1280,85,1360,74.7L1440,64L1440,120L1360,120C1280,120,1120,120,960,120C800,120,640,120,480,120C320,120,160,120,80,120L0,120Z"></path></svg>');
            background-size: cover;
        }

        .ship-bridge {
            position: relative;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(10, 26, 42, 0.9) 0%, rgba(10, 42, 58, 0.7) 100%);
            border-bottom: 2px solid var(--ship-gold);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ship-compass {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            border: 2px solid var(--ship-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary-dark);
            font-size: 18px;
        }

        #user-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--ship-gold);
            object-fit: cover;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            flex-shrink: 0;
        }

        .user-info-compact {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #user-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--ship-gold);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance-display-compact {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .balance-item-compact {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid var(--ship-silver);
            white-space: nowrap;
        }

        .balance-item-compact span {
            font-weight: 700;
            color: var(--ship-gold);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px;
            z-index: 2;
            position: relative;
        }

        .stat-card {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .stat-card h3 {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            color: var(--text-secondary-dark);
        }

        .stat-card p {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--ship-gold);
        }

        .contest-status-box {
            padding: 15px;
            border-radius: 12px;
            margin: 15px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .contest-status-active {
            border-color: var(--success);
            background: rgba(39, 174, 96, 0.1);
        }

        .contest-status-ended {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }

        .contest-status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--ship-gold);
        }

        .contest-status-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--ship-gold);
        }

        .contest-status-message {
            font-size: 0.9rem;
            color: var(--text-secondary-dark);
            margin-top: 8px;
        }

        .converter-container, .contest-container, .withdraw-container {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 15px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 2;
            position: relative;
        }

        .converter-header, .withdraw-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .converter-header i, .withdraw-header i {
            font-size: 1.5rem;
            color: var(--ship-gold);
        }

        .converter-header h3, .withdraw-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--ship-gold);
            margin: 0;
        }

        .converter-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .converter-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .converter-input-group input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-dark);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary-dark);
        }

        .converter-currency {
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            color: var(--ship-gold);
        }

        .converter-arrow {
            text-align: center;
            font-size: 1.5rem;
            color: var(--ship-gold);
        }

        .converter-rate {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary-dark);
            margin-top: 10px;
        }

        .ship-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background: linear-gradient(to top, var(--deck-wood) 0%, #6b3300 100%);
            border-top: 3px solid var(--ship-gold);
            z-index: 1000;
        }

        .control-wheel {
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--ship-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            color: var(--text-primary-dark);
            font-size: 0.75rem;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .control-wheel::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: 
                radial-gradient(circle, transparent 55%, var(--ship-gold) 55%, var(--ship-gold) 60%, transparent 60%),
                radial-gradient(circle, transparent 65%, var(--ship-gold) 65%, var(--ship-gold) 70%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: rotateGear 10s linear infinite;
        }

        @keyframes rotateGear {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-wheel i {
            font-size: 1.5rem;
            margin-bottom: 4px;
            position: relative;
            z-index: 2;
        }

        .control-wheel span {
            position: relative;
            z-index: 2;
        }

        .control-wheel.active {
            background: radial-gradient(circle, var(--ship-gold) 0%, #daa520 100%);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        .control-wheel:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.7);
        }

        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--background-dark) 0%, #0a2a3a 100%);
        }

        .ship-anchor {
            width: 80px;
            height: 80px;
            position: relative;
            animation: anchorSwing 2s infinite ease-in-out;
        }

        .ship-anchor::before {
            content: "‚öì";
            font-size: 80px;
            color: var(--ship-silver);
        }

        @keyframes anchorSwing {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }

        .ship-wheel-loader {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 20px;
        }

        .ship-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--ship-silver) 0%, #888 100%);
            border: 5px solid var(--ship-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: wheelRotate 3s linear infinite;
            position: relative;
        }

        .ship-wheel::before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--ship-gold);
            border-radius: 50%;
        }

        .ship-wheel::after {
            content: "";
            position: absolute;
            width: 80%;
            height: 80%;
            border: 2px dashed var(--ship-gold);
            border-radius: 50%;
            animation: wheelRotateReverse 2s linear infinite;
        }

        @keyframes wheelRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes wheelRotateReverse {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .ship-floating {
            animation: shipFloat 2s ease-in-out infinite;
        }

        @keyframes shipFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        #loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--ship-gold);
        }

        .page {
            display: none;
            padding: 15px;
            padding-bottom: 100px;
            position: relative;
            z-index: 2;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-btn, .convert-btn, .withdraw-btn, .claim-daily-btn, .claim-referral-btn, .redeem-code-btn, .subscribe-ad-btn, .check-subscription-btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(45deg, var(--ship-gold), #ffa500);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .action-btn:disabled, .convert-btn:disabled, .withdraw-btn:disabled, .claim-daily-btn:disabled, .claim-referral-btn:disabled, .redeem-code-btn:disabled, .subscribe-ad-btn:disabled {
            background: #808B96;
            cursor: not-allowed;
        }

        .action-btn:hover:not(:disabled), .convert-btn:hover:not(:disabled), .withdraw-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .task-container {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(26, 43, 60, 0.8);
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }

        .task-icon-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary-dark);
            margin-bottom: 4px;
        }

        .task-info p {
            font-size: 0.8rem;
            color: var(--text-secondary-dark);
            margin-bottom: 3px;
        }

        .ad-progress-inline {
            font-size: 0.75rem;
            color: var(--ship-gold);
            font-weight: 600;
            margin-top: 5px;
        }

        .add-task-btn {
            background: linear-gradient(45deg, var(--ship-gold), #ffa500);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px auto;
            width: 90%;
            max-width: 300px;
            animation: pulse 2s infinite;
            font-size: 1rem;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .add-task-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.8);
            animation: none;
        }

        .add-task-btn i {
            font-size: 1.1rem;
        }

        .progress-container-inline {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .progress-info-inline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .progress-bar-bg-inline {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        .progress-bar-fg-inline {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--ship-gold), #ffa500);
            transition: width 0.3s ease;
        }

        .banned-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .banned-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .banned-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .banned-message {
            font-size: 1.1rem;
            margin-bottom: 25px;
            max-width: 400px;
        }

        .banned-contact {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .popup-content { padding: 30px; border-radius: 15px; text-align: center; max-width: 80%; background: rgba(26, 43, 60, 0.95); border: 2px solid var(--ship-gold); position: relative; }
        .popup-content h2 { margin-bottom: 15px; color: var(--ship-gold); }
        .popup-content p { margin-bottom: 20px; color: var(--text-primary-dark); }
        .popup-close-btn { padding: 10px 25px; border: none; border-radius: 8px; color: #fff; background: linear-gradient(45deg, var(--ship-gold), #ffa500); cursor: pointer; }
        .popup-loader .spinner { width: 40px; height: 40px; border-radius: 50%; border: 4px solid var(--ship-gold); border-top-color: transparent; animation: spin 1s linear infinite; margin: 0 auto 15px;}

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 10px; margin-bottom: 10px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .history-details p { margin: 0; } .history-details p:first-child { font-weight: 600; }
        .history-status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-completed { background-color: var(--success); } .status-pending { background-color: var(--pending); } .status-rejected { background-color: var(--danger); }

        .subscription-container { padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .channel-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin: 10px 0; border-radius: 8px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .channel-info { display: flex; align-items: center; gap: 10px; }
        .channel-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .channel-status { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .status-subscribed { background-color: var(--success); color: white; }
        .status-not-subscribed { background-color: var(--danger); color: white; }

        .countdown-display { font-size: 1.2rem; font-weight: 700; color: var(--ship-gold); margin: 10px 0; padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); text-align: center; }

        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-primary-dark); }
        .input-with-icon { position: relative; display: flex; align-items: center; }
        .input-with-icon i { position: absolute; left: 12px; color: var(--text-secondary-dark); z-index: 1; }
        .input-with-icon input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(255, 255, 255, 0.1); color: var(--text-primary-dark); font-family: monospace; font-size: 0.9rem; }
        .input-with-icon input:focus { outline: none; border-color: var(--ship-gold) !important; box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2); }

        .validation-message { font-size: 0.8rem; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        .validation-success { color: var(--success); }
        .validation-error { color: var(--danger); }
        .validation-info { color: var(--text-secondary-dark); }

        .referral-notice { font-size: 0.85rem; text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); }

        .daily-login-task { background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border: 2px solid var(--ship-gold); flex-direction: column; align-items: stretch; }

        .contest-timer { background: linear-gradient(45deg, var(--ship-gold), #ffa500); color: #000; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 1.1rem; }

        .contest-info-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .contest-info-card { padding: 15px; border-radius: 10px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .contest-info-value { font-size: 1.8rem; font-weight: 700; color: var(--ship-gold); margin: 5px 0; }
        .contest-info-label { font-size: 0.9rem; color: var(--text-secondary-dark); }

        .contest-guide-popup { 
            background: rgba(255, 215, 0, 0.1); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            border-left: 4px solid var(--ship-gold);
            cursor: pointer;
            transition: all 0.3s;
        }

        .contest-guide-popup:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(5px);
        }

        .contest-guide-popup h4 { 
            margin-bottom: 10px; 
            color: var(--ship-gold); 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contest-guide-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }

        .contest-prizes-compact { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .prize-compact-item { padding: 12px; border-radius: 8px; text-align: center; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }
        .prize-rank-compact { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .prize-amount-compact { font-weight: 700; color: var(--ship-gold); font-size: 1rem; }

        .contest-leaderboard-item-compact { display: flex; align-items: center; padding: 10px; margin: 6px 0; border-radius: 8px; transition: all 0.3s; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .contest-leaderboard-item-compact.current-user { background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2)); border: 2px solid var(--ship-gold); }
        .contest-rank-compact { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, var(--ship-gold), #ffa500); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; margin-right: 12px; font-size: 0.85rem; }
        .contest-user-name-compact { font-weight: 600; margin-bottom: 2px; font-size: 0.9rem; }
        .contest-user-points-compact { font-size: 0.8rem; color: var(--text-secondary-dark); }
        .contest-user-score-compact { font-weight: 700; color: var(--ship-gold); font-size: 1rem; margin-right: 10px; }
        .contest-user-prize { font-size: 0.8rem; color: var(--success); font-weight: 600; background: rgba(39, 174, 96, 0.1); padding: 4px 8px; border-radius: 12px; white-space: nowrap; }

        .view-full-btn { background: transparent; border: 1px solid var(--ship-gold); color: var(--ship-gold); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .view-full-btn:hover { background: var(--ship-gold); color: #000; }

        .referral-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .referral-stat-card { padding: 15px; border-radius: 10px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .referral-stat-value { font-size: 1.4rem; font-weight: 700; color: var(--ship-gold); margin-bottom: 5px; }
        .referral-stat-label { font-size: 0.8rem; color: var(--text-secondary-dark); }

        .referral-list { max-height: 200px; overflow-y: auto; margin: 15px 0; border-radius: 10px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .referral-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-dark); }
        .referral-list-item:last-child { border-bottom: none; }
        .referral-user-info { display: flex; align-items: center; gap: 10px; }
        .referral-user-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .referral-user-name { font-weight: 600; font-size: 0.9rem; }
        .referral-earnings { font-weight: 700; color: var(--success); font-size: 0.9rem; }

        .code-input-container { display: flex; gap: 10px; margin: 15px 0; }
        .code-input { flex: 1; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(255, 255, 255, 0.1); color: var(--text-primary-dark); font-family: monospace; font-weight: 600; text-transform: uppercase; }
        .code-input:focus { outline: none; border-color: var(--ship-gold); box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2); }
        .code-info { font-size: 0.8rem; color: var(--text-secondary-dark); margin-top: 10px; text-align: center; }

        .ad-channel-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; margin: 10px 0; border-radius: 8px; background: linear-gradient(45deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1)); border: 1px solid var(--border-dark); }
        .ad-channel-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .ad-channel-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .ad-channel-name { font-weight: 600; margin-bottom: 3px; }
        .ad-channel-description { font-size: 0.8rem; color: var(--text-secondary-dark); margin-bottom: 5px; }
        .ad-channel-contact { font-size: 0.75rem; color: var(--ship-gold); font-weight: 600; }
        .ad-channel-reward { text-align: right; margin-right: 15px; }
        .ad-reward-amount { font-size: 1.1rem; font-weight: 700; color: var(--ship-gold); margin-bottom: 5px; }
        .ad-reward-label { font-size: 0.75rem; color: var(--text-secondary-dark); }

        .daily-calendar-popup { max-width: 450px !important; position: relative; }
        .close-popup-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--ship-gold);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-popup-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .streak-calendar-compact { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 15px 0; }
        .calendar-day-compact { padding: 10px; border-radius: 8px; text-align: center; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); }
        .calendar-day-compact.completed { background: rgba(76, 175, 80, 0.2); border-color: var(--success); }
        .calendar-day-compact.current { background: rgba(255, 215, 0, 0.2); border: 2px solid var(--ship-gold); }
        .calendar-day-compact.future { background: rgba(255, 255, 255, 0.05); opacity: 0.6; }
        .day-number-compact { font-weight: 700; margin-bottom: 5px; }
        .day-reward-compact { font-size: 0.8rem; color: var(--ship-gold); font-weight: 600; }
        .day-status-compact { font-size: 0.7rem; margin-top: 3px; }

        .daily-login-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            font-size: 0.9rem;
        }

        .referrals-container { padding: 20px; border-radius: 12px; margin: 20px 15px; background: rgba(26, 43, 60, 0.8); border: 1px solid var(--border-dark); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); }

        .withdrawal-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .withdrawal-option {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 1px solid var(--border-dark);
            background: rgba(26, 43, 60, 0.8);
            transition: all 0.3s;
        }

        .withdrawal-option.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--ship-gold);
        }

        .withdrawal-option i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--ship-gold);
        }

        .withdrawal-option h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary-dark);
        }

        .withdrawal-details {
            display: none;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
        }

        .withdrawal-details.active {
            display: block;
        }

        .withdrawal-info {
            font-size: 0.85rem;
            color: var(--text-secondary-dark);
            margin-bottom: 15px;
        }

        .withdrawal-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .withdrawal-info li {
            margin-bottom: 5px;
        }

        .method-details {
            display: none;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            margin-bottom: 20px;
        }

        .method-details.active {
            display: block;
        }

        .withdraw-amount-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-top: 5px;
            color: var(--text-secondary-dark);
        }

        .withdraw-btn-disabled {
            background: #808B96 !important;
            cursor: not-allowed !important;
        }

        .withdraw-btn-enabled {
            background: linear-gradient(45deg, var(--ship-gold), #ffa500) !important;
        }

        .contest-info-compact {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .contest-info-item {
            text-align: center;
            padding: 10px;
        }

        .contest-info-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ship-gold);
            margin-bottom: 5px;
        }

        .contest-info-item .label {
            font-size: 0.8rem;
            color: var(--text-secondary-dark);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--ship-gold);
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ≠ÿ∏ÿ± -->
    <div id="banned-page" class="banned-container">
        <div class="banned-icon">üö´</div>
        <div class="banned-title">Account Banned</div>
        <div class="banned-message" id="banned-reason">Your account has been suspended for violating our terms of service.</div>
        <div class="banned-contact">If you believe this is a mistake, please contact @Elsayed_1_Elgohary</div>
    </div>

    <!-- ÿßŸÑŸÜÿ¨ŸàŸÖ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ© -->
    <div class="stars" id="stars"></div>

    <div id="app-loader">
        <div class="ship-wheel-loader ship-floating">
            <div class="ship-wheel"></div>
        </div>
        <p id="loading-text">Preparing Your Ship...</p>
    </div>
    
    <!-- ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® -->
    <div id="popup" class="popup-overlay">
        <div class="popup-content">
            <div id="popup-body"></div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸäŸàŸÖŸä ÿßŸÑŸÖÿπÿØŸÑÿ© -->
    <div id="daily-calendar-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content daily-calendar-popup">
            <button class="close-popup-btn" onclick="closeDailyCalendar()">√ó</button>
            <h2>üìÖ Daily Login Calendar</h2>
            <div id="streak-calendar-compact" class="streak-calendar-compact">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸäÿßŸÖ ŸáŸÜÿß -->
            </div>
            <div id="daily-login-status" class="daily-login-status">
                <!-- ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ© -->
            </div>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                <p style="margin: 0; font-size: 0.9rem;">Current Streak: <strong id="current-streak-display">0 days</strong></p>
            </div>
            <button class="popup-close-btn" onclick="closeDailyCalendar()" style="margin-top: 15px;">Close</button>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© -->
    <div id="contest-guide-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content" style="max-width: 400px;">
            <button class="close-popup-btn" onclick="closeContestGuide()">√ó</button>
            <h2>üéØ How to Earn Points</h2>
            <div style="text-align: left; margin: 20px 0;">
                <p><strong>+1 Point</strong> for every ad watched</p>
                <p><strong>+15 Points</strong> for every successful referral</p>
                <p><strong>+10-50 Points</strong> for redeeming codes</p>
                <p>Compete for <strong>2 TON</strong> in total prizes!</p>
            </div>
            
            <h3>üèÜ Prize Distribution</h3>
            <div class="contest-prizes-compact" style="margin: 15px 0;">
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ü•á 1st</div>
                    <div class="prize-amount-compact">0.6 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ü•à 2nd</div>
                    <div class="prize-amount-compact">0.4 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">ü•â 3rd</div>
                    <div class="prize-amount-compact">0.3 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">4th-5th</div>
                    <div class="prize-amount-compact">0.15 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">6th-8th</div>
                    <div class="prize-amount-compact">0.1 TON</div>
                </div>
                <div class="prize-compact-item">
                    <div class="prize-rank-compact">9th-10th</div>
                    <div class="prize-amount-compact">0.05 TON</div>
                </div>
            </div>
            <button class="popup-close-btn" onclick="closeContestGuide()">Close</button>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ£ŸÑÿπÿßÿ® -->
    <div id="games-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content" style="max-width: 400px;">
            <button class="close-popup-btn" onclick="closeGamesPopup()">√ó</button>
            <div id="games-popup-content">
                <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ£ŸÑÿπÿßÿ® -->
            </div>
        </div>
    </div>
    
    <!-- ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© -->
    <div class="ship-container">
        <!-- ÿßŸÑÿ£ŸÖŸàÿßÿ¨ -->
        <div class="wave"></div>
        <div class="wave wave-2"></div>

        <!-- ÿßŸÑÿ¨ÿ≥ÿ± (ÿßŸÑÿ±ÿ£ÿ≥) ÿßŸÑŸÖÿπÿØŸÑ -->
        <header class="ship-bridge">
            <img id="user-photo" src="https://ui-avatars.com/api/?name=User&background=random&size=80" alt="User">
            <div class="user-info-compact">
                <h1 id="user-name">Loading...</h1>
                <div class="balance-display-compact">
                    <div class="balance-item-compact">Main: <span id="user-balance">0.0000</span> TON</div>
                    <div class="balance-item-compact">RR: <span id="user-rr-balance">0</span></div>
                </div>
            </div>
            <div class="ship-compass">
                <i class="fas fa-compass"></i>
            </div>
        </header>

        <!-- ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
        <main id="main-content">
            <div id="home-page" class="page active">
                <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ±ÿ®ÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© -->
                <div class="contest-status-box contest-status-active" id="contest-status-box">
                    <div class="contest-status-title">Contest Status</div>
                    <div class="contest-status-value" id="contest-status-value">Active</div>
                    <div class="contest-status-message" id="contest-status-message">You are currently ranked #7 in the contest</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card"><h3>Today's Ads</h3><p id="daily-ads-watched">0 / 0</p></div>
                    <div class="stat-card"><h3>Total Ads Watched</h3><p id="total-ads-watched">0</p></div>
                </div>
                <div id="converter-container" class="converter-container">
                    <div class="converter-header">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>RR to TON Converter</h3>
                    </div>
                    <div class="converter-form">
                        <div class="converter-input-group">
                            <input type="number" id="rr-amount" placeholder="0" min="0" step="100">
                            <div class="converter-currency">RR</div>
                        </div>
                        <div class="converter-arrow">‚áÖ</div>
                        <div class="converter-input-group">
                            <input type="number" id="ton-amount" placeholder="0.0000" min="0" step="0.0001" readonly>
                            <div class="converter-currency">TON</div>
                        </div>
                        <div class="converter-rate">
                            üí± Exchange Rate: 10,000,000 RR = 0.1 TON
                        </div>
                        <button id="convert-rr-btn" class="convert-btn" disabled>Convert to TON</button>
                    </div>
                </div>
                <div id="dynamic-links-container" style="margin-top: 20px;"></div>
            </div>

            <div id="tasks-page" class="page">
                <!-- ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© Earning Wallet -->
                
                <div id="ad-progress-container" class="progress-container-inline"></div>
                <div id="ad-task-container"></div>
                
                <!-- ÿÆÿßŸÜÿ© ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ£ŸÉŸàÿßÿØ ÿßŸÑŸÖÿµÿ∫ÿ±ÿ© -->
                <div id="redeem-code-container">
                    <div class="task-container" style="flex-direction: row; align-items: center; padding: 12px;">
                        <i class="fas fa-ticket-alt" style="font-size: 1.2rem; color: var(--ship-gold); margin-right: 10px;"></i>
                        <div class="task-info" style="flex: 1;">
                            <h3 style="font-size: 1rem;">Redeem Code</h3>
                            <p style="font-size: 0.8rem;">Enter code for rewards</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="redeem-code-input" class="code-input" 
                                   placeholder="CODE" maxlength="20" style="width: 100px; padding: 8px;">
                            <button id="redeem-code-btn" class="redeem-code-btn" style="padding: 8px 12px;">
                                Redeem
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÿ≤ÿ± ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ© ÿ¨ÿØŸäÿØ - ÿ™ŸÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ -->
                <button class="add-task-btn" id="add-task-main-btn">
                    <i class="fas fa-plus-circle"></i> Add Task
                </button>
                
                <h2>Bonus Tasks</h2>
                <!-- ‚ùå ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ÿ© -->
                <div id="dynamic-tasks-container">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">
                        <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No additional tasks available at the moment.</p>
                        <p style="font-size: 0.9rem;">Check back later for new tasks!</p>
                    </div>
                </div>
                
                <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØ -->
                <div id="daily-tasks-container" style="margin-top: 20px;">
                    <h2>üìÖ Daily Tasks</h2>
                    <p style="font-size: 0.9rem; color: var(--text-secondary-dark); margin-bottom: 15px;">
                        Complete daily tasks to earn extra RR rewards! Resets daily at midnight.
                    </p>
                    
                    <div id="daily-tasks-list">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖŸäÿ© ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                    </div>
                </div>
            </div>

            <!-- üéÆ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸÑÿπÿßÿ® ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
            <div id="games-page" class="page">
                <div class="contest-container">
                    <h2>üéÆ Mini Games</h2>
                    <p>Play games and win RR rewards!</p>
                    
                    <!-- ŸÑÿπÿ®ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ -->
                    <div class="task-container" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <i class="fas fa-keyboard" style="font-size: 2rem; color: var(--ship-gold);"></i>
                            <div>
                                <h3>Number Challenge</h3>
                                <p>Tap numbers from 1-9 in order. Win 500 RR!</p>
                            </div>
                        </div>
                        <button id="play-number-game" class="action-btn" style="width: 100%;">
                            üéØ Play Number Challenge
                        </button>
                    </div>

                    <!-- ŸÑÿπÿ®ÿ© ÿßŸÑÿ≥ÿ®ŸäŸÜ -->
                    <div class="task-container" style="flex-direction: column; align-items: stretch; margin-top: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <i class="fas fa-sync-alt" style="font-size: 2rem; color: var(--ship-gold);"></i>
                            <div>
                                <h3>Spin Wheel</h3>
                                <p>Spin the wheel and win up to 10,000 RR!</p>
                                <small style="color: var(--text-secondary-dark);">Cost: 100 RR per spin</small>
                            </div>
                        </div>
                        <button id="play-spin-game" class="action-btn" style="width: 100%;">
                            üé° Spin Wheel (100 RR)
                        </button>
                    </div>

                    <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ£ŸÑÿπÿßÿ® -->
                    <div id="game-stats-container" style="margin-top: 20px; padding: 15px; background: rgba(26, 43, 60, 0.8); border-radius: 10px;">
                        <h3>üìä Game Statistics</h3>
                        <div id="game-stats-content">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸáŸÜÿß -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="contest-page" class="page">
                <div class="contest-container">
                    <div class="contest-header">
                        <h2>üèÜ Weekly Contest</h2>
                        <p>Compete with other users and win amazing prizes!</p>
                    </div>
                    
                    <div class="contest-timer">
                        <div id="contest-countdown">Loading...</div>
                    </div>
                    
                    <!-- ‚ùå ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸäÿØŸàŸä -->
                    
                    <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÜŸÇÿßÿ∑ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿØŸÖÿ¨ -->
                    <div class="contest-info-compact">
                        <div class="contest-info-item">
                            <div class="value" id="user-contest-points">0</div>
                            <div class="label">Your Points</div>
                        </div>
                        <div class="contest-info-item">
                            <div class="value" id="user-contest-rank">-</div>
                            <div class="label">Your Rank</div>
                        </div>
                    </div>
                    
                    <!-- ‚ùå ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ŸÖÿ§ÿ¥ÿ± ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ -->
                    
                    <!-- ÿ≤ÿ± ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÖÿπÿØŸÑ -->
                    <div class="contest-guide-popup" id="contest-guide-trigger">
                        <h4>
                            <i class="fas fa-question-circle" style="font-size: 1.5rem;"></i>
                            How to Earn Points & Prize Distribution
                        </h4>
                        <div class="contest-guide-content" id="contest-guide-content">
                            <p><strong>+1 Point</strong> for every ad watched</p>
                            <p><strong>+15 Points</strong> for every successful referral</p>
                            <p><strong>+10-50 Points</strong> for redeeming codes</p>
                            <p>Compete for <strong>2 TON</strong> in total prizes!</p>
                            
                            <div class="contest-prizes-compact" style="margin-top: 15px;">
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ü•á 1st</div>
                                    <div class="prize-amount-compact">0.6 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ü•à 2nd</div>
                                    <div class="prize-amount-compact">0.4 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">ü•â 3rd</div>
                                    <div class="prize-amount-compact">0.3 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">4th-5th</div>
                                    <div class="prize-amount-compact">0.15 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">6th-8th</div>
                                    <div class="prize-amount-compact">0.1 TON</div>
                                </div>
                                <div class="prize-compact-item">
                                    <div class="prize-rank-compact">9th-10th</div>
                                    <div class="prize-amount-compact">0.05 TON</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="contest-leaderboard-compact">
                        <h3>üèÖ Top 10 Leaders</h3>
                        <div id="contest-leaderboard-compact-list">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ ÿßŸÑŸÖÿÆÿ™ÿµÿ±ÿ© ŸáŸÜÿß -->
                        </div>
                        <div class="view-full-leaderboard">
                            <button class="view-full-btn" onclick="showFullLeaderboard()">
                                View Full Leaderboard (Top 50)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
            <div id="referrals-page" class="page">
                <div class="referrals-container">
                    <h2>üë• Refer & Earn</h2>
                    <p>Invite friends and earn <strong>15% of their earnings</strong></p>
                    
                    <div class="referral-stats">
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="total-referrals-display">0</div>
                            <div class="referral-stat-label">Total Referrals</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="total-earnings-display">0.0000</div>
                            <div class="referral-stat-label">Total Earnings</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value" id="pending-earnings-display">0.0000</div>
                            <div class="referral-stat-label">Pending Earnings</div>
                        </div>
                        <div class="referral-stat-card">
                            <div class="referral-stat-value">15%</div>
                            <div class="referral-stat-label">Commission Rate</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>üìã Your Referral Link</h4>
                        <input type="text" id="referral-link" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px dashed var(--ship-gold); background: transparent; color: inherit; text-align: center; margin: 10px 0;">
                        <button id="copy-ref-link-btn" class="action-btn" style="width: 100%;">
                            üìã Copy Referral Link
                        </button>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>üë§ Your Referrals</h4>
                        <div class="referral-list" id="referrals-list-container">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™ ŸáŸÜÿß -->
                        </div>
                    </div>
                    
                    <button class="claim-referral-btn" id="claim-referral-earnings-btn" style="width: 100%; margin-top: 15px;" disabled>
                        üéÅ Claim Referral Earnings
                    </button>
                </div>
            </div>

            <div id="profile-page" class="page">
                <!-- ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™ ŸÖŸÜ ŸáŸÜÿß -->
                <div id="withdraw-section"></div>
                <div id="withdrawal-history-section" style="margin-top: 20px;">
                    <h2>Withdrawal History</h2>
                    <div id="withdrawal-history-list"></div>
                </div>
            </div>
        </main>

        <!-- ÿπÿ¨ŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ŸÅŸÑŸäÿ©) -->
        <nav class="ship-controls">
            <div class="control-wheel active" data-page="home-page">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="control-wheel" data-page="tasks-page">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </div>
            <div class="control-wheel" data-page="games-page">
                <i class="fas fa-gamepad"></i>
                <span>Games</span>
            </div>
            <div class="control-wheel" data-page="contest-page">
                <i class="fas fa-trophy"></i>
                <span>Contest</span>
            </div>
            <div class="control-wheel" data-page="referrals-page">
                <i class="fas fa-users"></i>
                <span>Referrals</span>
            </div>
            <div class="control-wheel" data-page="profile-page">
                <i class="fas fa-user-alt"></i>
                <span>Profile</span>
            </div>
        </nav>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp || {};
    const NOTIFICATION_USERNAME = "Elsayed_1_Elgohary";

    // üîó ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
    const API_BASE_URL = 'https://ton-rewards-backend-production-5e56.up.railway.app';
    let currentDynamicToken = '';
    let lastTokenUpdate = 0;
    let tokenRefreshInterval;

    // üîÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸä ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
    async function getCurrentToken() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/token/current`);
            const data = await response.json();
            if (data.success && data.token) {
                currentDynamicToken = data.token;
                lastTokenUpdate = Date.now();
                console.log('üîê ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ');
                return currentDynamicToken;
            }
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ™ŸàŸÉŸÜ:', error);
            if (currentDynamicToken && (Date.now() - lastTokenUpdate < 25000)) {
                return currentDynamicToken;
            }
        }
        return null;
    }

    // üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
    async function ensureValidToken() {
        const now = Date.now();
        if (now - lastTokenUpdate > 10000 || !currentDynamicToken) {
            return await getCurrentToken();
        }
        return currentDynamicToken;
    }

    // üîÑ ÿ®ÿØÿ° ŸÜÿ∏ÿßŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ
    function startTokenRefreshSystem() {
        getCurrentToken();
        tokenRefreshInterval = setInterval(getCurrentToken, 9000);
    }

    // üõ†Ô∏è ÿØŸàÿßŸÑ API ŸÑŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
    const api = {
        getCurrentToken: async () => {
            const response = await fetch(`${API_BASE_URL}/api/token/current`);
            return await response.json();
        },

        getTokenStats: async () => {
            const response = await fetch(`${API_BASE_URL}/api/token/stats`);
            return await response.json();
        },

        getUser: async (userId, initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/user/${userId}?initData=${encodeURIComponent(initData)}`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        },

        register: async (initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ initData })
            });
            return await response.json();
        },

        // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© - ÿ®ÿØŸàŸÜ ÿ™ÿπŸÇŸäÿØ
        watchAd: async (initData) => {
            const token = await ensureValidToken();
            
            try {
                console.log('üîÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ•ŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...');
                
                const response = await fetch(`${API_BASE_URL}/api/watch-ad`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Dynamic-Token': token
                    },
                    body: JSON.stringify({ initData })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
                    return data;
                } else {
                    throw new Error(data.error || 'ŸÅÿ¥ŸÑ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ');
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿπŸÑÿßŸÜ:', error);
                throw error;
            }
        },

        moveToBalance: async (initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/move-to-balance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ initData })
            });
            return await response.json();
        },

        withdraw: async (initData, amount, walletAddress, method = 'TON Wallet', memo = '') => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/withdraw`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ 
                    initData, 
                    amount, 
                    walletAddress, 
                    method, 
                    memo 
                })
            });
            return await response.json();
        },

        getWithdrawals: async (userId, initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/withdrawals/${userId}?initData=${encodeURIComponent(initData)}`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        },

        getConfig: async () => {
            const response = await fetch(`${API_BASE_URL}/api/config`);
            return await response.json();
        },

        getDatabaseStatus: async () => {
            const response = await fetch(`${API_BASE_URL}/api/database/status`);
            return await response.json();
        },

        // üèÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
        updateContestPoints: async (userId, points = 1, adsWatched = 1, referralsCount = 0) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/contest/update-points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ 
                    userId, 
                    points, 
                    adsWatched, 
                    referralsCount 
                })
            });
            return await response.json();
        },

        getContestLeaderboard: async () => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/contest/leaderboard`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        },

        getUserContestRank: async (userId) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/contest/user-rank/${userId}`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        },

        getUserContestData: async (userId) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/contest/user/${userId}`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        },

        // üéÆ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÑÿπÿßÿ® ÿßŸÑÿ¨ÿØŸäÿØ
        playNumberChallenge: async (userId, score, timeLeft, initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/games/number-challenge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ 
                    userId, 
                    score, 
                    timeLeft, 
                    initData 
                })
            });
            return await response.json();
        },

        playSpinWheel: async (userId, cost, reward, initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/games/spin-wheel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Dynamic-Token': token
                },
                body: JSON.stringify({ 
                    userId, 
                    cost, 
                    reward, 
                    initData 
                })
            });
            return await response.json();
        },

        getGameStats: async (userId, initData) => {
            const token = await ensureValidToken();
            const response = await fetch(`${API_BASE_URL}/api/games/stats/${userId}?initData=${encodeURIComponent(initData)}`, {
                headers: {
                    'X-Dynamic-Token': token,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        }
    };

    // ‚úÖ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    let dailyLoginRewards = [0.0001, 0.0002, 0.0004, 0.0008, 0.0016, 0.0032, 0.0064];
    let minAdDuration = 0;

    // üö´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿØŸàŸÑ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ÿ©
    const bannedCountries = [
        'IN', 'RU', 'LY', 'AF', 'NL', 'MN', 'US', 'LK', 'UA'
    ];

    let isUserBanned = false;
    let banReason = "";
    let lastAdWatchTime = 0;
    let adStartTime = 0;
    let isAdInProgress = false;
    let adWatchTimer = null;

    let appConfig = {}; 
    let userState = {}; 
    let tgUser = {}; 
    let earningWalletBalance = 0;
    let userTransactions = [];
    let isSubscribedToAllChannels = true;

    // ‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    let contestData = {
        userPoints: 0,
        userRank: 0,
        leaderboard: [],
        endTime: null,
        durationDays: 7,
        isActive: true
    };

    // ‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸäŸàŸÖŸä
    let dailyLoginData = {
        currentStreak: 0,
        lastLoginDate: null,
        claimedDays: []
    };

    // ‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
    let referralData = {
        totalEarnings: 0,
        pendingEarnings: 0,
        referredUsers: []
    };

    // ‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÉŸàÿßÿØ
    let redeemedCodes = [];

    // ‚úÖ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπŸÖŸÑÿ©
    let userRRBalance = 0;
    const RR_TO_TON_RATE = 10000000;

    // üåç ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÉÿ¥ŸÅ ÿßŸÑÿØŸàŸÑÿ©
    let userCountryData = null;
    let isUserCountryAllowed = true;

    const popup = document.getElementById('popup');
    const popupBody = document.getElementById('popup-body');
    const loadingText = document.getElementById('loading-text');

    // ‚úÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ¨ŸàŸÖ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
    function createStars() {
        const starsContainer = document.getElementById('stars');
        const starCount = 100;
        
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            
            const left = Math.random() * 100;
            const top = Math.random() * 100;
            const size = Math.random() * 3;
            const duration = 3 + Math.random() * 7;
            const delay = Math.random() * 5;
            
            star.style.left = `${left}%`;
            star.style.top = `${top}%`;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.animationDuration = `${duration}s`;
            star.style.animationDelay = `${delay}s`;
            
            starsContainer.appendChild(star);
        }
    }

    const showPopup = (content) => { popupBody.innerHTML = content; popup.style.display = 'flex'; };
    const closePopup = () => { popup.style.display = 'none'; };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ŸÖÿ≠ÿßÿØÿ´ÿ© Telegram
    const openTelegramContact = () => {
        const telegramUrl = 'https://t.me/Elsayed_1_Elgohary';
        try {
            if (tg.openLink) {
                tg.openLink(telegramUrl);
            } else {
                window.open(telegramUrl, '_blank');
            }
        } catch (error) {
            window.open(telegramUrl, '_blank');
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    window.openContestGuide = () => {
        document.getElementById('contest-guide-popup').style.display = 'flex';
    };

    // ‚úÖ ÿØÿßŸÑÿ© ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    window.closeContestGuide = () => {
        document.getElementById('contest-guide-popup').style.display = 'none';
    };

    // ‚úÖ ÿØÿßŸÑÿ© ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ£ŸÑÿπÿßÿ®
    window.closeGamesPopup = () => {
        document.getElementById('games-popup').style.display = 'none';
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿ∏ÿ±
    const checkUserBanStatus = async () => {
        const bannedStatus = localStorage.getItem(`userBanned_${tgUser.id || 'guest'}`);
        if (bannedStatus === 'true') {
            isUserBanned = true;
            banReason = localStorage.getItem(`banReason_${tgUser.id || 'guest'}`) || "Violation of terms of service";
            showBannedPage();
            return true;
        }
        return false;
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ≠ÿ∏ÿ±
    const showBannedPage = () => {
        document.getElementById('banned-reason').textContent = banReason;
        document.getElementById('banned-page').style.display = 'flex';
        document.getElementById('app-loader').style.display = 'none';
        document.querySelector('.ship-container').style.display = 'none';
    };

    // üìç ÿØÿßŸÑÿ© ŸÑŸÉÿ¥ŸÅ ÿßŸÑÿØŸàŸÑÿ©
    const detectUserCountry = async () => {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                countryCode: data.country_code,
                countryName: data.country_name,
                ip: data.ip
            };
        } catch (error) {
            console.error('Error detecting country:', error);
            return {
                countryCode: 'UNKNOWN',
                countryName: 'Unknown',
                ip: 'Unknown'
            };
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸàŸÑÿ© ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©
    const isCountryAllowed = (countryCode) => {
        if (bannedCountries.includes(countryCode)) {
            return false;
        }
        return true;
    };

    // üõ°Ô∏è ÿØÿßŸÑÿ© ÿ®ÿØŸäŸÑÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜ - ŸÖÿ®ÿßÿ¥ÿ±ÿ©
    const handleSimpleAd = async () => {
        return new Promise((resolve) => {
            showPopup(`
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üì∫</div>
                    <h2 style="color: var(--ship-gold); margin-bottom: 10px;">Watch Ad</h2>
                    <p style="margin-bottom: 20px; color: var(--text-primary-dark);">
                        Please watch the ad to receive your reward.
                    </p>
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary-dark);">
                            ‚è±Ô∏è Watch for at least 15 seconds
                        </p>
                    </div>
                    <button class="popup-close-btn" id="manual-ad-complete" 
                            style="background: linear-gradient(45deg, var(--ship-gold), #ffa500); color: #000; width: 100%;">
                        I Watched the Ad
                    </button>
                </div>
            `);

            document.getElementById('manual-ad-complete').addEventListener('click', () => {
                closePopup();
                resolve(true);
            });
        });
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ
    const loadContestLeaderboard = async () => {
        try {
            const response = await api.getContestLeaderboard();
            if (response.success) {
                contestData.leaderboard = response.leaderboard;
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ:', contestData.leaderboard.length);
                
                if (document.getElementById('contest-page').classList.contains('active')) {
                    renderContestPage();
                }
            }
        } catch (error) {
            console.error('Error loading contest leaderboard:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    const loadUserContestRank = async () => {
        try {
            const response = await api.getUserContestRank(tgUser.id);
            if (response.success) {
                contestData.userRank = response.rank;
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', contestData.userRank);
                return response.rank;
            }
        } catch (error) {
            console.error('Error loading user contest rank:', error);
        }
        return 0;
    };

    // üö´ ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÇŸäŸäÿØ ÿßŸÑÿØŸàŸÑÿ©
    const showCountryRestrictionMessage = () => {
        const homePage = document.getElementById('home-page');
        if (homePage) {
            const existingMessage = document.getElementById('country-restriction-message');
            if (!existingMessage) {
                const restrictionMessage = document.createElement('div');
                restrictionMessage.id = 'country-restriction-message';
                restrictionMessage.style.cssText = `
                    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    margin: 15px;
                    text-align: center;
                    border: 2px solid #ffd700;
                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                `;
                restrictionMessage.innerHTML = `
                    <h3 style="margin-bottom: 8px; color: white;">üö´ Regional Restriction</h3>
                    <p style="margin: 0; font-size: 0.9rem;">
                        Ads are not available in ${userCountryData.countryName}. 
                    </p>
                `;
                homePage.insertBefore(restrictionMessage, homePage.firstChild);
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    const saveUserState = () => {
        localStorage.setItem(`userState_${tgUser.id || 'guest'}`, JSON.stringify(userState));
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    const loadUserState = () => {
        const savedState = localStorage.getItem(`userState_${tgUser.id || 'guest'}`);
        if (savedState) {
            userState = JSON.parse(savedState);
        } else {
            userState = {
                id: tgUser.id || 'guest',
                firstName: tgUser.first_name || '',
                lastName: tgUser.last_name || '',
                username: tgUser.username || '',
                photoUrl: tgUser.photo_url || '',
                balance: 0,
                dailyAdCount: 0,
                lifetimeAdCount: 0,
                totalEarned: 0,
                lastAdWatchDate: new Date().toISOString().slice(0, 10),
                breakUntil: 0,
                completedTasks: {},
                referrals: 0,
                referredBy: null
            };
        }
    };

    // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const startContestAutoRefresh = () => {
        setInterval(async () => {
            if (document.getElementById('contest-page').classList.contains('active')) {
                console.log('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ...');
                await loadContestLeaderboard();
                await loadUserContestRank();
            }
        }, 30000);
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
    const checkServerHealth = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/health`);
            const data = await response.json();
            return data.status === 'healthy';
        } catch (error) {
            console.error('‚ùå ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠:', error);
            return false;
        }
    };

    // üîç ÿØÿßŸÑÿ© ŸÅÿ≠ÿµ initData
    function debugInitData() {
        const tg = window.Telegram?.WebApp;
        console.log('=== üîç ŸÅÿ≠ÿµ Telegram WebApp Data ===');
        console.log('initData:', tg.initData);
        console.log('initDataUnsafe:', tg.initDataUnsafe);
        console.log('User:', tg.initDataUnsafe?.user);
    }

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    const initApp = async () => {
        try {
            createStars();
            
            if (tg.ready) { 
                tg.ready(); 
                try { 
                    tg.expand(); 
                } catch(e){} 
            }
            
            tgUser = (tg.initDataUnsafe && tg.initDataUnsafe.user) || {};
            
            console.log('üì± Telegram WebApp Data:', {
                user: tgUser,
                initData: tg.initData,
                initDataUnsafe: tg.initDataUnsafe
            });

            debugInitData();

            startTokenRefreshSystem();

            const configResponse = await api.getConfig();
            if (configResponse.success) {
                appConfig = configResponse.config;
                console.log('‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±:', appConfig);
            } else {
                appConfig = {
                    dailyAdLimit: 100,
                    adValue: 0.0001,
                    botUsername: "UfnpBot_bot",
                    referralBonus: 0.001,
                    minimumWithdrawReferrals: 0
                };
            }

            console.log('üåç Detecting user country...');
            const userCountry = await detectUserCountry();
            console.log('üìç User country detected:', userCountry);
            
            const isAllowed = isCountryAllowed(userCountry.countryCode);
            console.log(`üéØ Country ${userCountry.countryCode} allowed:`, isAllowed);
            
            userCountryData = userCountry;
            isUserCountryAllowed = isAllowed;

            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            console.log('üîë initData ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', initData.substring(0, 100) + '...');

            const userResponse = await api.getUser(tgUser.id, initData);
            
            if (userResponse.success) {
                userState = {
                    id: userResponse.user.id,
                    firstName: userResponse.user.firstName,
                    lastName: '',
                    username: userResponse.user.username,
                    photoUrl: tgUser.photo_url || '',
                    balance: userResponse.user.balance,
                    dailyAdCount: userResponse.user.dailyAdCount,
                    lifetimeAdCount: 0,
                    totalEarned: userResponse.user.totalEarned,
                    lastAdWatchDate: new Date().toISOString().slice(0, 10),
                    breakUntil: 0,
                    completedTasks: {},
                    referrals: 0,
                    referredBy: null
                };
                
                earningWalletBalance = userResponse.user.earningWallet;
                
                console.log('‚úÖ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±:', userResponse.user);
            } else {
                const registerResponse = await api.register(initData);
                if (registerResponse.success) {
                    userState = {
                        id: registerResponse.user.id,
                        firstName: registerResponse.user.firstName,
                        lastName: '',
                        username: registerResponse.user.username,
                        photoUrl: tgUser.photo_url || '',
                        balance: registerResponse.user.balance,
                        dailyAdCount: registerResponse.user.dailyAdCount,
                        lifetimeAdCount: 0,
                        totalEarned: registerResponse.user.totalEarned,
                        lastAdWatchDate: new Date().toISOString().slice(0, 10),
                        breakUntil: 0,
                        completedTasks: {},
                        referrals: 0,
                        referredBy: null
                    };
                    
                    earningWalletBalance = registerResponse.user.earningWallet;
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ:', registerResponse.user);
                } else {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ£Ÿà ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                }
            }

            await loadContestData();
            await loadContestLeaderboard();
            await loadUserContestRank();
            await loadDailyLoginData();
            await loadReferralData();
            await loadRedeemedCodes();

            userRRBalance = parseInt(localStorage.getItem(`userRRBalance_${tgUser.id || 'guest'}`) || '0');

            await continueAppInitialization();
            
        } catch (error) { 
            console.error("Initialization failed:", error); 
            try { 
                if (tg.showAlert) tg.showAlert("Failed to load app data. Please try again."); 
            } catch(e){} 
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    const continueAppInitialization = async () => {
        try {
            await resetDailyTasks();

            renderUI(); 
            setupNavigation(); 
            setupEventListeners();
            setupGameEventListeners();

            startContestAutoRefresh();

            setTimeout(() => {
                document.getElementById('app-loader').style.display = 'none';
                document.querySelector('.ship-container').style.display = 'block';
            }, 300);
        } catch (error) {
            console.error("Error in continueAppInitialization:", error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const loadContestData = async () => {
        try {
            const savedContest = localStorage.getItem(`contestData_${tgUser.id || 'guest'}`);
            if (savedContest) {
                contestData = JSON.parse(savedContest);
            } else {
                contestData = {
                    userPoints: 0,
                    userRank: 0,
                    leaderboard: [],
                    endTime: new Date().getTime() + (7 * 24 * 60 * 60 * 1000),
                    durationDays: 7,
                    isActive: true
                };
            }
        } catch (error) {
            console.error('Error loading contest data:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸäŸàŸÖŸä
    const loadDailyLoginData = async () => {
        try {
            const savedData = localStorage.getItem(`dailyLoginData_${tgUser.id || 'guest'}`);
            if (savedData) {
                dailyLoginData = JSON.parse(savedData);
            await checkDailyLogin();
            localStorage.setItem(`dailyLoginData_${tgUser.id || 'guest'}`, JSON.stringify(dailyLoginData));
            return;
            }
            
            dailyLoginData = {
                currentStreak: 0,
                lastLoginDate: null,
                claimedDays: []
            };
            
            await checkDailyLogin();
            
        } catch (error) {
            console.error('Error loading daily login data:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸäŸàŸÖŸä
    const checkDailyLogin = async () => {
        const today = new Date().toDateString();
        const lastLogin = dailyLoginData.lastLoginDate;
        
        if (lastLogin !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastLogin === yesterdayStr) {
                dailyLoginData.currentStreak = (dailyLoginData.currentStreak || 0) + 1;
            } else if (lastLogin !== today) {
                dailyLoginData.currentStreak = 1;
            }
            
            dailyLoginData.lastLoginDate = today;
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
    const loadReferralData = async () => {
        try {
            const savedData = localStorage.getItem(`referralData_${tgUser.id || 'guest'}`);
            if (savedData) {
                referralData = JSON.parse(savedData);
            } else {
                referralData = {
                    totalEarnings: 0,
                    pendingEarnings: 0,
                    referredUsers: []
                };
            }
        } catch (error) {
            console.error('Error loading referral data:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÉŸàÿßÿØ
    const loadRedeemedCodes = async () => {
        try {
            const savedCodes = localStorage.getItem(`redeemedCodes_${tgUser.id || 'guest'}`);
            if (savedCodes) {
                redeemedCodes = JSON.parse(savedCodes);
            } else {
                redeemedCodes = [];
            }
        } catch (error) {
            console.error('Error loading redeemed codes:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÄ renderUI
    const renderUI = () => {
        document.getElementById('user-photo').src = userState.photoUrl || 'https://ui-avatars.com/api/?name=User&background=random&size=80';
        document.getElementById('user-name').textContent = `${userState.firstName || ''} ${userState.lastName || ''}`.trim() || 'User';
        document.getElementById('user-balance').textContent = (userState.balance || 0).toFixed(4);
        document.getElementById('user-rr-balance').textContent = userRRBalance.toLocaleString();
        
        const dailyLimit = 100;
        document.getElementById('daily-ads-watched').textContent = `${userState.dailyAdCount || 0} / ${dailyLimit}`;
        document.getElementById('total-ads-watched').textContent = userState.lifetimeAdCount || 0;
        
        updateContestStatus();
        
        if (!isUserCountryAllowed && userCountryData) {
            showCountryRestrictionMessage();
        }
        
        renderAdTask(); 
        renderAdProgress(); 
        renderDynamicTasks(); 
        renderReferralsPage();
        renderWithdrawSection(); 
        renderConverter(); 
        renderDynamicLinks();
        renderGameStats();
        
        setupAdditionalEventListeners();
        
        loadDailyTasks();
        
        loadWithdrawalHistory();
    };

    // ‚úÖ ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™
    const loadWithdrawalHistory = async () => {
        try {
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const withdrawalsResponse = await api.getWithdrawals(tgUser.id, initData);
            
            if (withdrawalsResponse.success) {
                userTransactions = withdrawalsResponse.withdrawals || [];
                renderWithdrawalHistory();
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™:', userTransactions.length);
            } else {
                console.error('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™:', withdrawalsResponse.error);
            }
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™:', error);
        }
    };

    // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© renderAdProgress ŸÑŸÑÿ≠ÿØ ÿßŸÑŸäŸàŸÖŸä 100
    const renderAdProgress = () => {
        const container = document.getElementById('ad-progress-container');
        const dailyLimit = 100;
        const watchedCount = userState.dailyAdCount || 0;
        const percentage = Math.min(100, (watchedCount / dailyLimit) * 100);
        container.innerHTML = `
            <div class="progress-info-inline">
                <span>Daily Ad Progress</span>
                <span>${watchedCount} / ${dailyLimit}</span>
            </div>
            <div class="progress-bar-bg-inline">
                <div class="progress-bar-fg-inline" style="width: ${percentage}%;"></div>
            </div>`;
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ŸÖÿ≠ŸàŸÑ ÿßŸÑÿπŸÖŸÑÿ©
    const renderConverter = () => {
        const rrInput = document.getElementById('rr-amount');
        const tonInput = document.getElementById('ton-amount');
        const convertBtn = document.getElementById('convert-rr-btn');
        
        if (rrInput && tonInput && convertBtn) {
            rrInput.value = '';
            tonInput.value = '';
            convertBtn.disabled = true;
            
            rrInput.addEventListener('input', () => {
                const rrValue = parseFloat(rrInput.value) || 0;
                const tonValue = rrValue / RR_TO_TON_RATE;
                tonInput.value = tonValue.toFixed(8);
                convertBtn.disabled = rrValue <= 0 || rrValue > userRRBalance;
            });
            
            convertBtn.addEventListener('click', convertRRToTON);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ RR ÿ•ŸÑŸâ TON
    const convertRRToTON = async () => {
        const rrAmount = parseFloat(document.getElementById('rr-amount').value) || 0;
        
        if (rrAmount <= 0) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Please enter a valid amount of RR to convert."); 
            }catch(e) {
                alert("‚ùå Please enter a valid amount of RR to convert.");
            }
            return;
        }
        
        if (rrAmount > userRRBalance) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå You don't have enough RR to convert."); 
            }catch(e) {
                alert("‚ùå You don't have enough RR to convert.");
            }
            return;
        }
        
        const tonAmount = rrAmount / RR_TO_TON_RATE;
        const roundedTonAmount = Math.floor(tonAmount * 100000000) / 100000000;
        
        try {
            userRRBalance = Math.floor((userRRBalance - rrAmount) * 100) / 100;
            localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
            
            userState.balance = (userState.balance || 0) + roundedTonAmount;
            userState.balance = Math.floor(userState.balance * 100000000) / 100000000;
            saveUserState();
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert(`‚úÖ Successfully converted ${rrAmount.toLocaleString()} RR to ${roundedTonAmount.toFixed(8)} TON!`); 
            }catch(e) {
                alert(`‚úÖ Successfully converted ${rrAmount.toLocaleString()} RR to ${roundedTonAmount.toFixed(8)} TON!`);
            }
            
            renderUI();
            
        } catch (error) {
            console.error('‚ùå Error converting RR to TON:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Failed to convert RR. Please try again."); 
            }catch(e) {
                alert("‚ùå Failed to convert RR. Please try again.");
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™
    const renderWithdrawalHistory = () => {
        const listEl = document.getElementById('withdrawal-history-list');
        
        if (!listEl) {
            console.error('‚ùå ÿπŸÜÿµÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
            return;
        }
        
        if (userTransactions.length === 0) { 
            listEl.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">
                    <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>No withdrawal history found.</p>
                    <p style="font-size: 0.9rem;">Your withdrawal requests will appear here.</p>
                </div>
            `; 
            return; 
        }
        
        listEl.innerHTML = userTransactions.map(item => {
            let displayDate = 'Invalid Date';
            try {
                if (item.createdat) {
                    const date = new Date(item.createdat);
                    if (!isNaN(date.getTime())) {
                        displayDate = date.toLocaleString();
                    } else {
                        displayDate = item.createdat;
                    }
                } else if (item.created_at) {
                    const date = new Date(item.created_at);
                    if (!isNaN(date.getTime())) {
                        displayDate = date.toLocaleString();
                    } else {
                        displayDate = item.created_at;
                    }
                }
            } catch (error) {
                console.error('Error parsing date:', error);
                displayDate = 'Date not available';
            }
            
            return `
                <div class="history-item">
                    <div class="history-details">
                        <p>${Number(item.amount).toFixed(4)} TON - ${item.method}</p>
                        <small>${displayDate}</small>
                        ${item.memo ? `<br><small style="color: var(--text-secondary-dark);">Memo: ${item.memo}</small>` : ''}
                    </div>
                    <span class="history-status status-${item.status}">${item.status}</span>
                </div>`;
        }).join('');
    };

    const setupNavigation = () => {
        const controlWheels = document.querySelectorAll('.control-wheel'); 
        const pages = document.querySelectorAll('.page');
        controlWheels.forEach(wheel => {
            wheel.addEventListener('click', () => {
                const pageId = wheel.dataset.page;
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                controlWheels.forEach(w => w.classList.remove('active'));
                wheel.classList.add('active');
                if (pageId === 'profile-page') { 
                    loadWithdrawalHistory(); 
                }
                if (pageId === 'contest-page') { 
                    renderContestPage(); 
                }
                if (pageId === 'referrals-page') {
                    renderReferralsPage();
                }
                if (pageId === 'games-page') {
                    renderGameStats();
                }
            });
        });
    };

    const setupEventListeners = () => {
        popup.addEventListener('click', (e) => { 
            if (e.target.classList.contains('popup-close-btn') || e.target.id === 'popup') closePopup(); 
        });
        document.getElementById('dynamic-tasks-container').addEventListener('click', (e) => handleClaimTask(e));
        document.getElementById('profile-page').addEventListener('submit', (e) => handleWithdraw(e));
        document.getElementById('redeem-code-btn').addEventListener('click', redeemCode);
        document.getElementById('redeem-code-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                redeemCode();
            }
        });
    };

    // üéÆ ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑŸÑÿ£ŸÑÿπÿßÿ®
    const setupGameEventListeners = () => {
        // ŸÑÿπÿ®ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
        document.getElementById('play-number-game')?.addEventListener('click', startNumberGame);
        
        // ŸÑÿπÿ®ÿ© ÿßŸÑÿ≥ÿ®ŸäŸÜ
        document.getElementById('play-spin-game')?.addEventListener('click', startSpinGame);
    };

    // üéØ ÿØÿßŸÑÿ© ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
    const startNumberGame = async () => {
        showPopup(`
            <div style="text-align: center;">
                <h2>üéØ Number Challenge</h2>
                <p>Tap numbers from 1 to 9 in order!</p>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--ship-gold);">
                        üèÜ Win 500 RR if you complete all numbers!
                    </p>
                </div>
                <button class="popup-close-btn" onclick="startNumberChallengeGame()" style="width: 100%;">
                    Start Game
                </button>
            </div>
        `);
    };

    // üéØ ÿØÿßŸÑÿ© ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿßŸÑÿ≥ÿ®ŸäŸÜ
    const startSpinGame = async () => {
        if (userRRBalance < 100) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå You need at least 100 RR to play Spin Wheel!"); 
            }catch(e) {
                alert("‚ùå You need at least 100 RR to play Spin Wheel!");
            }
            return;
        }

        showPopup(`
            <div style="text-align: center;">
                <h2>üé° Spin Wheel</h2>
                <p>Spin to win RR rewards!</p>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--ship-gold);">
                        üí∞ Cost: 100 RR per spin<br>
                        üéÅ Prizes: 50 RR to 10,000 RR!
                    </p>
                </div>
                <button class="popup-close-btn" onclick="startSpinWheelGame()" style="width: 100%;">
                    Spin Wheel (100 RR)
                </button>
            </div>
        `);
    };

    // üéØ ÿØÿßŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÑÿπÿ®ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
    window.startNumberChallengeGame = async () => {
        closePopup();
        
        const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        let currentNumber = 1;
        let startTime = Date.now();
        
        showPopup(`
            <div style="text-align: center;">
                <h2>üéØ Number Challenge</h2>
                <p>Tap numbers in order from 1 to 9</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                    ${numbers.map(num => `
                        <button class="number-btn" data-number="${num}" 
                                style="padding: 20px; font-size: 1.5rem; border-radius: 10px; border: 2px solid var(--ship-gold); background: rgba(255, 215, 0, 0.1); color: white; cursor: pointer;">
                            ${num}
                        </button>
                    `).join('')}
                </div>
                <div style="background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0; font-size: 0.9rem;">Next: <strong>${currentNumber}</strong></p>
                </div>
                <button class="popup-close-btn" onclick="closePopup()" style="background: #666; width: 100%;">
                    Cancel Game
                </button>
            </div>
        `);

        // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑÿ£ÿ±ŸÇÿßŸÖ
        setTimeout(() => {
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clickedNumber = parseInt(this.getAttribute('data-number'));
                    
                    if (clickedNumber === currentNumber) {
                        this.style.background = 'var(--success)';
                        this.style.borderColor = 'var(--success)';
                        currentNumber++;
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ™ÿßŸÑŸä
                        const nextElement = document.querySelector('div p strong');
                        if (nextElement) {
                            nextElement.textContent = currentNumber;
                        }
                        
                        // ÿ•ÿ∞ÿß ÿßŸÉÿ™ŸÖŸÑÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
                        if (currentNumber > 9) {
                            const endTime = Date.now();
                            const timeTaken = Math.floor((endTime - startTime) / 1000);
                            
                            setTimeout(async () => {
                                await processNumberGameResult(9, timeTaken);
                            }, 1000);
                        }
                    } else {
                        this.style.background = 'var(--danger)';
                        this.style.borderColor = 'var(--danger)';
                        
                        setTimeout(async () => {
                            const score = currentNumber - 1;
                            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
                            await processNumberGameResult(score, timeTaken);
                        }, 500);
                    }
                });
            });
        }, 100);
    };

    // üéØ ÿØÿßŸÑÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ŸÜÿ™Ÿäÿ¨ÿ© ŸÑÿπÿ®ÿ© ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
    const processNumberGameResult = async (score, timeTaken) => {
        try {
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const gameResponse = await api.playNumberChallenge(tgUser.id, score, timeTaken, initData);
            
            closePopup();
            
            if (gameResponse.success) {
                userRRBalance = gameResponse.userRRBalance;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                let message = `üéØ Game Completed!\nScore: ${score}/9\n`;
                if (score === 9) {
                    message += `üèÜ You won ${gameResponse.rewardRR} RR!`;
                } else {
                    message += `Better luck next time!`;
                }
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(message); 
                }catch(e) {
                    alert(message);
                }
                
                renderUI();
                renderGameStats();
                
            } else {
                throw new Error(gameResponse.error);
            }
        } catch (error) {
            console.error('‚ùå Error processing game result:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Failed to process game result. Please try again."); 
            }catch(e) {
                alert("‚ùå Failed to process game result. Please try again.");
            }
        }
    };

    // üé° ÿØÿßŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÑÿπÿ®ÿ© ÿßŸÑÿ≥ÿ®ŸäŸÜ
    window.startSpinWheelGame = async () => {
        closePopup();
        
        if (userRRBalance < 100) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå You don't have enough RR to play!"); 
            }catch(e) {
                alert("‚ùå You don't have enough RR to play!");
            }
            return;
        }

        // ÿÆÿµŸÖ ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        userRRBalance -= 100;
        localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
        
        // ŸÖÿ≠ÿßŸÉÿßÿ© ÿØŸàÿ±ÿßŸÜ ÿßŸÑÿπÿ¨ŸÑÿ©
        showPopup(`
            <div style="text-align: center;">
                <h2>üé° Spinning...</h2>
                <div style="font-size: 3rem; margin: 20px 0; animation: spin 1s linear infinite;">
                    ‚è≥
                </div>
                <p>Good luck!</p>
            </div>
        `);

        // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÜÿ™Ÿäÿ¨ÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
        setTimeout(async () => {
            const rewards = [50, 100, 200, 500, 1000, 2000, 5000, 10000];
            const randomReward = rewards[Math.floor(Math.random() * rewards.length)];
            
            try {
                const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
                const spinResponse = await api.playSpinWheel(tgUser.id, 100, randomReward, initData);
                
                closePopup();
                
                if (spinResponse.success) {
                    userRRBalance = spinResponse.userRRBalance;
                    localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                    
                    const netGain = randomReward - 100;
                    let message = `üé° Spin Result!\n`;
                    if (netGain > 0) {
                        message += `üéâ You won ${randomReward} RR! (Net: +${netGain} RR)`;
                    } else {
                        message += `üòû You won ${randomReward} RR (Net: ${netGain} RR)`;
                    }
                    
                    try{ 
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                        if (tg.showAlert) tg.showAlert(message); 
                    }catch(e) {
                        alert(message);
                    }
                    
                    renderUI();
                    renderGameStats();
                    
                } else {
                    throw new Error(spinResponse.error);
                }
            } catch (error) {
                console.error('‚ùå Error processing spin result:', error);
                // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ RR ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
                userRRBalance += 100;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                try{ 
                    if (tg.showAlert) tg.showAlert("‚ùå Failed to process spin. Your RR has been refunded."); 
                }catch(e) {
                    alert("‚ùå Failed to process spin. Your RR has been refunded.");
                }
            }
        }, 2000);
    };

    // üìä ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ£ŸÑÿπÿßÿ®
    const renderGameStats = async () => {
        const statsContainer = document.getElementById('game-stats-content');
        if (!statsContainer) return;

        try {
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const statsResponse = await api.getGameStats(tgUser.id, initData);
            
            if (statsResponse.success) {
                const stats = statsResponse.stats;
                statsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--ship-gold);">${stats.totalGamesPlayed || 0}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary-dark);">Total Games</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--ship-gold);">${(stats.totalRewardsEarned || 0).toFixed(4)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary-dark);">Total TON Won</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--ship-gold);">Number Challenge</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="text-align: center; padding: 8px; background: rgba(255, 215, 0, 0.05); border-radius: 6px;">
                                <div style="font-weight: 700; color: var(--ship-gold);">${stats.numberChallenge?.bestScore || 0}/9</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary-dark);">Best Score</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(255, 215, 0, 0.05); border-radius: 6px;">
                                <div style="font-weight: 700; color: var(--ship-gold);">${stats.numberChallenge?.totalPlayed || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary-dark);">Games Played</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; color: var(--ship-gold);">Spin Wheel</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="text-align: center; padding: 8px; background: rgba(255, 215, 0, 0.05); border-radius: 6px;">
                                <div style="font-weight: 700; color: var(--ship-gold);">${stats.spinWheel?.totalSpins || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary-dark);">Total Spins</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(255, 215, 0, 0.05); border-radius: 6px;">
                                <div style="font-weight: 700; color: var(--ship-gold);">${(stats.spinWheel?.totalWon || 0).toFixed(4)}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary-dark);">TON Won</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No game statistics yet.</p>
                        <p style="font-size: 0.9rem;">Play games to see your stats!</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading game stats:', error);
            statsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">
                    <p>Failed to load game statistics.</p>
                </div>
            `;
        }
    };

    // ÿ®ÿßŸÇŸä ÿßŸÑÿØŸàÿßŸÑ ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä ŸÖÿπ ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ÿ≥Ÿäÿ∑ÿ©...
        // ‚úÖ ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
    const setupAdditionalEventListeners = () => {
        // ÿ≤ÿ± ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸáŸÖÿ©
        document.getElementById('add-task-main-btn').addEventListener('click', openTelegramContact);
        
        // ÿ≤ÿ± ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
        document.getElementById('contest-guide-trigger').addEventListener('click', function() {
            const content = document.getElementById('contest-guide-content');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ŸÖŸáŸÖÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ
    const renderAdTask = () => {
        const container = document.getElementById('ad-task-container');
        const now = Date.now();
        const onBreak = userState.breakUntil && now < userState.breakUntil;
        const limitReached = userState.dailyAdCount >= 100;
        
        // üåç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸàŸÑÿ© ÿ£ŸàŸÑÿßŸã
        if (!isUserCountryAllowed) {
            const countryName = userCountryData.countryName || 'your region';
            container.innerHTML = `
                <div class="task-container">
                    <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/globe.png" alt="icon">
                    <div class="task-info">
                        <h3>Regional Restriction</h3>
                        <p>Ads are not available in ${countryName}.</p>
                        <p style="color: var(--text-secondary-dark); font-size: 0.8rem;">
                            Thank you for your understanding.
                        </p>
                    </div>
                    <button class="action-btn" disabled>Not Available</button>
                </div>`;
            return;
        }
        
        let html = '';
        if (onBreak) {
            const remaining = Math.ceil((userState.breakUntil - now) / 60000);
            html = `
                <div class="task-container">
                    <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/hourglass.png" alt="icon">
                    <div class="task-info">
                        <h3>Break Time!</h3>
                        <p>Please wait for ${remaining} more minutes.</p>
                    </div>
                    <button class="action-btn" disabled>Waiting</button>
                </div>`;
        } else if (limitReached) {
            html = `
                <div class="task-container">
                    <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/stop-circled.png" alt="icon">
                    <div class="task-info">
                        <h3>Daily Limit Reached</h3>
                        <p>Come back tomorrow for more ads.</p>
                    </div>
                    <button class="action-btn" disabled>Limit</button>
                </div>`;
        } else {
            const adValueRR = 1000;
            html = `
                <div class="task-container">
                    <img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/play-button-circled.png" alt="icon">
                    <div class="task-info">
                        <h3>Watch Ad</h3>
                        <p>Earn ${adValueRR.toLocaleString()} RR +1 contest point for every ad.</p>
                    </div>
                    <button id="watch-ad-btn" class="action-btn">Watch Ad</button>
                </div>`;
        }
        container.innerHTML = html;
        if (!onBreak && !limitReached) { 
            const btn = document.getElementById('watch-ad-btn'); 
            if (btn) btn.addEventListener('click', handleWatchAd); 
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© - ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿØŸàŸÜ ÿ™ÿπŸÇŸäÿØ
    const handleWatchAd = async () => {
        // üåç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸàŸÑÿ© ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ© ÿ£ŸàŸÑÿßŸã
        if (!isUserCountryAllowed) {
            const countryName = userCountryData.countryName || 'your country';
            try{ 
                if (tg.showAlert) tg.showAlert(`üö´ Ads are not available in ${countryName}.`); 
            }catch{} 
            return; 
        }

        if (isUserBanned) {
            try{ 
                if (tg.showAlert) tg.showAlert("Your account is banned. Contact support."); 
            }catch{} 
            return; 
        }

        if (userState.dailyAdCount >= 100) {
            try{ 
                if (tg.showAlert) tg.showAlert("You have reached your daily ad watch limit."); 
            }catch{} 
            return; 
        }
        
        const currentTime = Date.now();
        if (userState.breakUntil && currentTime < userState.breakUntil) {
            const remaining = Math.ceil((userState.breakUntil - currentTime) / 60000);
            try{ 
                if (tg.showAlert) tg.showAlert(`Please wait for ${remaining} more minutes.`); 
            }catch{} 
            return;
        }

        const watchBtn = document.getElementById('watch-ad-btn');
        if (watchBtn) {
            watchBtn.disabled = true;
            watchBtn.textContent = 'Loading...';
        }

        // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ®ÿ≥ÿ∑ ŸÑŸÑÿ•ÿπŸÑÿßŸÜ
        try {
            const adWatched = await handleSimpleAd();
            
            if (!adWatched) {
                if (watchBtn) {
                    watchBtn.disabled = false;
                    watchBtn.textContent = 'Watch Ad';
                }
                return;
            }

            // ‚úÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const watchResponse = await api.watchAd(initData);
            
            if (watchResponse.success) {
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
                earningWalletBalance = watchResponse.earningWallet;
                userState.dailyAdCount = watchResponse.dailyRemaining ? (100 - watchResponse.dailyRemaining) : (userState.dailyAdCount || 0) + 1;
                userState.lifetimeAdCount = (userState.lifetimeAdCount || 0) + 1;
                userState.totalEarned = watchResponse.totalEarned;
                userState.balance = watchResponse.balance || userState.balance;

                // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ RR ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
                if (watchResponse.userRRBalance !== undefined) {
                    userRRBalance = watchResponse.userRRBalance;
                } else {
                    userRRBalance += 1000;
                }
                
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());

                // ‚úÖ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
                let rewardMessage = `üéâ Ad completed! +1,000 RR`;
                
                // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿ∑ÿ© ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÜÿ¥ÿ∑ÿ©
                if (contestData.isActive && watchResponse.contestPoints === 1) {
                    rewardMessage += ` +1 Contest Point! üéØ`;
                    
                    contestData.userPoints = (contestData.userPoints || 0) + 1;
                    localStorage.setItem(`contestData_${tgUser.id || 'guest'}`, JSON.stringify(contestData));
                    
                    setTimeout(async () => {
                        await loadContestLeaderboard();
                        await loadUserContestRank();
                    }, 1000);
                }
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(rewardMessage); 
                }catch{}
                
                renderUI();

            } else {
                throw new Error(watchResponse.error || 'Failed to process ad reward');
            }

        } catch (error) {
            console.error("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ:", error);
            
            let errorMessage = "Ad could not be processed. Please try again.";
            
            if (error.message.includes('network') || error.message.includes('fetch')) {
                errorMessage = "Network error. Please check your connection.";
            }
            
            try{ 
                if (tg.showAlert) tg.showAlert(errorMessage); 
            }catch{}
            
            if (watchBtn) {
                watchBtn.disabled = false;
                watchBtn.textContent = 'Watch Ad';
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
    const renderDynamicTasks = () => {
        const container = document.getElementById('dynamic-tasks-container'); 
        container.innerHTML = '';
        
        const defaultTasks = [];
        
        if (defaultTasks.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">
                    <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>No additional tasks available at the moment.</p>
                    <p style="font-size: 0.9rem;">Check back later for new tasks!</p>
                </div>
            `;
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿ®ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
    const handleClaimTask = async (e) => {
        if (isUserBanned) {
            try{ 
                if (tg.showAlert) tg.showAlert("Your account is banned. Contact support."); 
            }catch(e) {
                alert("Your account is banned. Contact support.");
            }
            return; 
        }

        if (e.target.classList.contains('action-btn') && e.target.dataset.taskId) {
            const taskId = e.target.dataset.taskId;
            const taskUrl = e.target.dataset.taskUrl;
            
            if (!taskUrl) { 
                try{ 
                    if (tg.showAlert) tg.showAlert('You have already claimed this bonus.'); 
                }catch(e) {
                    alert('You have already claimed this bonus.');
                }
                return; 
            }

            if (userState.completedTasks && userState.completedTasks[taskId]) { 
                try{ 
                    if (tg.showAlert) tg.showAlert('You have already claimed this bonus.'); 
                }catch(e) {
                    alert('You have already claimed this bonus.');
                }
                return; 
            }

            e.target.disabled = true; 
            e.target.textContent = 'Claiming...';
            
            try {
                const rewardAmountRR = 5000;
                userRRBalance += rewardAmountRR;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                
                if (!userState.completedTasks) userState.completedTasks = {};
                userState.completedTasks[taskId] = true;
                saveUserState();
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert(`Thank you! You received ${rewardAmountRR.toLocaleString()} RR.`); 
                }catch(e) {
                    alert(`Thank you! You received ${rewardAmountRR.toLocaleString()} RR.`);
                }
                renderUI();
            } catch (error) { 
                try{ 
                    if (tg.showAlert) tg.showAlert('Failed to claim bonus.'); 
                }catch(e) {
                    alert('Failed to claim bonus.');
                }
                e.target.disabled = false; 
                e.target.textContent = 'Claim Bonus'; 
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿπÿ±ÿ∂ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖŸäÿ©
    const loadDailyTasks = async () => {
        const dailyTasksList = document.getElementById('daily-tasks-list');
        if (!dailyTasksList) return;

        try {
            const claimedTasks = JSON.parse(localStorage.getItem(`dailyTasks_${tgUser.id || 'guest'}`) || '{}');
            const watchedToday = userState.dailyAdCount || 0;
            
            const dailyTasks = [
                { id: 'daily_login', name: 'Daily Login', required: 0, current: 1, reward: 5000, claimed: false },
                { id: 'watch_50_ads', name: 'Watch 50 Ads Today', required: 50, current: watchedToday, reward: 10000, claimed: false },
                { id: 'watch_100_ads', name: 'Watch 100 Ads Today', required: 100, current: watchedToday, reward: 20000, claimed: false }
            ];

            let tasksHTML = '';
            
            dailyTasks.forEach(task => {
                const isCompleted = task.current >= task.required;
                const isClaimed = claimedTasks[task.id] || false;
                const progressPercentage = Math.min(100, (task.current / task.required) * 100);
                
                tasksHTML += `
                    <div class="task-container" style="position: relative;">
                        <div class="task-info" style="flex: 1;">
                            <h3>${task.name}</h3>
                            <p>Watch ${task.required.toLocaleString()} ads today - Reward: ${task.reward.toLocaleString()} RR</p>
                            
                            <div class="progress-container-inline" style="margin: 8px 0;">
                                <div class="progress-info-inline">
                                    <span>Today's Progress</span>
                                    <span>${task.current.toLocaleString()} / ${task.required.toLocaleString()}</span>
                                </div>
                                <div class="progress-bar-bg-inline">
                                    <div class="progress-bar-fg-inline" style="width: ${progressPercentage}%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="action-btn ${isCompleted && !isClaimed ? '' : 'disabled'}" 
                                data-task-id="${task.id}" 
                                data-task-reward="${task.reward}"
                                ${isCompleted && !isClaimed ? '' : 'disabled'}
                                style="min-width: 80px;">
                            ${isClaimed ? '‚úÖ Claimed' : (isCompleted ? 'üéÅ Claim' : 'In Progress')}
                        </button>
                        
                        ${isClaimed ? '<div style="position: absolute; top: 5px; right: 5px; background: var(--success); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">Claimed</div>' : ''}
                    </div>
                `;
            });
            
            dailyTasksList.innerHTML = tasksHTML;
            
            document.querySelectorAll('#daily-tasks-list .action-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', handleDailyTaskClaim);
            });
            
        } catch (error) {
            console.error('Error loading daily tasks:', error);
            dailyTasksList.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading daily tasks</p>';
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿ®ŸÖŸáŸÖÿ© ŸäŸàŸÖŸäÿ©
    const handleDailyTaskClaim = async (e) => {
        const taskId = e.target.dataset.taskId;
        const reward = parseInt(e.target.dataset.taskReward);
        
        if (!taskId || !reward) return;
        
        try {
            const claimedTasks = JSON.parse(localStorage.getItem(`dailyTasks_${tgUser.id || 'guest'}`) || '{}');
            
            if (claimedTasks[taskId]) {
                try{ 
                    if (tg.showAlert) tg.showAlert("You have already claimed this task!"); 
                }catch(e) {
                    alert("You have already claimed this task!");
                }
                return;
            }
            
            userRRBalance += reward;
            localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
            
            claimedTasks[taskId] = {
                claimedAt: Date.now(),
                reward: reward,
                taskId: taskId
            };
            
            localStorage.setItem(`dailyTasks_${tgUser.id || 'guest'}`, JSON.stringify(claimedTasks));
            
            loadDailyTasks();
            renderUI();
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert(`üéâ Task completed! You earned ${reward.toLocaleString()} RR!`); 
            }catch(e) {
                alert(`üéâ Task completed! You earned ${reward.toLocaleString()} RR!`);
            }
            
        } catch (error) {
            console.error('Error claiming daily task:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("Failed to claim task reward. Please try again."); 
            }catch(e) {
                alert("Failed to claim task reward. Please try again.");
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖŸäÿ©
    const resetDailyTasks = async () => {
        try {
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem(`dailyTasks_lastReset_${tgUser.id || 'guest'}`);
            
            if (lastReset !== today) {
                console.log('üîÑ Resetting daily tasks for new day:', today);
                localStorage.removeItem(`dailyTasks_${tgUser.id || 'guest'}`);
                localStorage.setItem(`dailyTasks_lastReset_${tgUser.id || 'guest'}`, today);
                console.log('‚úÖ Daily tasks reset successfully for user:', tgUser.id);
            }
        } catch (error) {
            console.error('Error resetting daily tasks:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
    const renderReferralsPage = () => {
        const botUsername = appConfig.botUsername || "UfnpBot_bot";
        const userId = tgUser.id || '';
        
        const refLink = `https://t.me/${botUsername}?startapp=${userId}`;
        
        document.getElementById('total-referrals-display').textContent = userState.referrals || 0;
        document.getElementById('total-earnings-display').textContent = (referralData.totalEarnings || 0).toLocaleString() + ' RR';
        document.getElementById('pending-earnings-display').textContent = (referralData.pendingEarnings || 0).toLocaleString() + ' RR';
        document.getElementById('referral-link').value = refLink;
        
        let referredUsersHTML = '';
        if (referralData.referredUsers.length > 0) {
            referralData.referredUsers.forEach(user => {
                referredUsersHTML += `
                    <div class="referral-list-item">
                        <div class="referral-user-info">
                            <img src="${user.photoUrl}" alt="${user.name}" class="referral-user-avatar">
                            <div>
                                <div class="referral-user-name">${user.name}</div>
                                <small style="color: var(--text-secondary-dark);">Joined: ${new Date(user.joinDate).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div class="referral-earnings">+${((user.totalEarned || 0) * 0.15 * RR_TO_TON_RATE).toLocaleString()} RR</div>
                    </div>
                `;
            });
        } else {
            referredUsersHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary-dark);">No referrals yet. Share your link to start earning!</div>';
        }
        
        document.getElementById('referrals-list-container').innerHTML = referredUsersHTML;
        
        const claimBtn = document.getElementById('claim-referral-earnings-btn');
        if (referralData.pendingEarnings > 0) {
            claimBtn.disabled = false;
            claimBtn.textContent = `üéÅ Claim ${referralData.pendingEarnings.toLocaleString()} RR`;
        } else {
            claimBtn.disabled = true;
            claimBtn.textContent = 'üéÅ Claim Referral Earnings';
        }
        
        document.getElementById('copy-ref-link-btn').addEventListener('click', copyReferralLink);
        document.getElementById('claim-referral-earnings-btn').addEventListener('click', claimReferralEarnings);
    };

    const copyReferralLink = () => {
        const refLinkInput = document.getElementById('referral-link');
        refLinkInput.select();
        refLinkInput.setSelectionRange(0, 99999);
        try {
            navigator.clipboard.writeText(refLinkInput.value).then(() => {
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("Referral link copied!"); 
                }catch(e) {
                    alert("Referral link copied!");
                }
            });
        } catch (err) {
            document.execCommand('copy');
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert("Referral link copied!"); 
            }catch(e) {
                alert("Referral link copied!");
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿ£ÿ±ÿ®ÿßÿ≠ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™
    const claimReferralEarnings = async () => {
        try {
            if (referralData.pendingEarnings <= 0) {
                try{ 
                    if (tg.showAlert) tg.showAlert("No pending referral earnings to claim!"); 
                }catch(e) {
                    alert("No pending referral earnings to claim!");
                }
                return;
            }
            
            userRRBalance += referralData.pendingEarnings;
            localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
            
            referralData.totalEarnings += referralData.pendingEarnings;
            referralData.pendingEarnings = 0;
            
            localStorage.setItem(`referralData_${tgUser.id || 'guest'}`, JSON.stringify(referralData));
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert(`üéâ Referral earnings claimed! +${referralData.totalEarnings.toLocaleString()} RR`); 
            }catch(e) {
                alert(`üéâ Referral earnings claimed! +${referralData.totalEarnings.toLocaleString()} RR`);
            }
            
            renderUI();
            
        } catch (error) {
            console.error('Error claiming referral earnings:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("Failed to claim referral earnings. Please try again."); 
            }catch(e) {
                alert("Failed to claim referral earnings. Please try again.");
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ŸÇÿ≥ŸÖ ÿßŸÑÿ≥ÿ≠ÿ®
    const renderWithdrawSection = () => {
        const container = document.getElementById('withdraw-section'); 
        
        const withdrawMethods = [
            { name: 'FaucetPay', min: 0.0001, icon: 'fas fa-envelope' },
            { name: 'TON', min: 0.05, icon: 'fas fa-wallet' }
        ];

        const minRefs = appConfig.minimumWithdrawReferrals || 0;
        let referralNotice = '';
        if (minRefs > 0) {
            referralNotice = `
                <div class="referral-notice">
                    <i class="fas fa-info-circle"></i> You need at least <b>${minRefs} referrals</b> to be eligible for withdrawal.
                    <br>You currently have <b>${userState.referrals || 0} referrals</b>.
                </div>`;
        }

        container.innerHTML = `
            <div class="withdraw-container">
                <div class="withdraw-header">
                    <i class="fas fa-wallet"></i>
                    <h3>Withdraw Funds</h3>
                </div>
                
                ${referralNotice}
                
                <div class="withdrawal-options">
                    <div class="withdrawal-option active" data-method="faucetpay">
                        <i class="fas fa-envelope"></i>
                        <h4>FaucetPay</h4>
                    </div>
                    <div class="withdrawal-option" data-method="ton">
                        <i class="fas fa-wallet"></i>
                        <h4>TON Wallet</h4>
                    </div>
                </div>
                
                <div class="withdrawal-details active" id="faucetpay-details">
                    <div class="withdrawal-info">
                        <p><strong>FaucetPay Withdrawal</strong></p>
                        <p>Enter your Gmail address registered with FaucetPay</p>
                        <ul>
                            <li>Minimum withdrawal: 0.0001 TON</li>
                            <li>‚úÖ No fees - We cover all transaction costs</li>
                            <li>‚è≥ Processing time: Up to 1 minute</li>
                            <li>Withdrawals are processed automatically</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label for="faucetpay-email">FaucetPay Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="faucetpay-email" placeholder="your-email@gmail.com">
                        </div>
                        <div class="validation-message validation-info" id="faucetpay-validation">
                            <i class="fas fa-info-circle"></i> Enter your FaucetPay registered email
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="withdraw-amount-faucetpay">Amount (TON)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-coins"></i>
                            <input type="number" id="withdraw-amount-faucetpay" placeholder="0.0001" min="0.0001" step="0.0001">
                        </div>
                        <div class="validation-message validation-info" id="amount-validation-faucetpay">
                            <i class="fas fa-info-circle"></i> Minimum: 0.0001 TON
                        </div>
                    </div>
                    <button class="withdraw-btn" id="withdraw-faucetpay-btn">Withdraw via FaucetPay</button>
                </div>

                <div class="withdrawal-details" id="ton-details">
                    <div class="withdrawal-info">
                        <p><strong>TON Withdrawal</strong></p>
                        <p>Enter your TON wallet address (starts with UQ, EQ, or kQ)</p>
                        <ul>
                            <li>Minimum withdrawal: 0.05 TON</li>
                            <li>‚úÖ No fees - We cover all transaction costs</li>
                            <li>‚è≥ Processing time: Up to 24 hours</li>
                            <li>Optional: Add memo for exchange deposits</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label for="ton-address">TON Wallet Address</label>
                        <div class="input-with-icon">
                            <i class="fas fa-wallet"></i>
                            <input type="text" id="ton-address" placeholder="UQ...">
                        </div>
                        <div class="validation-message validation-info" id="ton-address-validation">
                            <i class="fas fa-info-circle"></i> Enter your TON wallet address
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ton-memo">Memo (Optional)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-sticky-note"></i>
                            <input type="text" id="ton-memo" placeholder="For exchange deposits">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="withdraw-amount-ton">Amount (TON)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-coins"></i>
                            <input type="number" id="withdraw-amount-ton" placeholder="0.05" min="0.05" step="0.01">
                        </div>
                        <div class="validation-message validation-info" id="amount-validation-ton">
                            <i class="fas fa-info-circle"></i> Minimum: 0.05 TON
                        </div>
                    </div>
                    <button class="withdraw-btn" id="withdraw-ton-btn">Withdraw to TON Wallet</button>
                </div>
            </div>`;

        setupWithdrawalEventListeners();
    };

    // ‚úÖ ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑŸÑÿ≥ÿ≠ÿ®
    const setupWithdrawalEventListeners = () => {
        document.querySelectorAll('.withdrawal-option').forEach(option => {
            option.addEventListener('click', function() {
                const method = this.getAttribute('data-method');
                switchWithdrawalMethod(method);
                
                document.querySelectorAll('.withdrawal-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.getElementById('ton-address').addEventListener('input', validateTONAddress);
        document.getElementById('faucetpay-email').addEventListener('input', validateFaucetPayEmail);
        
        document.getElementById('withdraw-faucetpay-btn').addEventListener('click', handleFaucetPayWithdrawal);
        document.getElementById('withdraw-ton-btn').addEventListener('click', handleTONWithdrawal);
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ®ÿØŸäŸÑ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ≥ÿ≠ÿ®
    const switchWithdrawalMethod = (method) => {
        document.getElementById('faucetpay-details').classList.toggle('active', method === 'faucetpay');
        document.getElementById('ton-details').classList.toggle('active', method === 'ton');
    };

    // ‚úÖ ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµÿ≠ÿ©
    const validateTONAddress = () => {
        const address = document.getElementById('ton-address').value.trim();
        const validation = document.getElementById('ton-address-validation');
        
        if (address === '') {
            validation.className = 'validation-message validation-info';
            validation.innerHTML = '<i class="fas fa-info-circle"></i> Enter your TON wallet address';
        } else if (/^(UQ|EQ|kQ)[a-zA-Z0-9_-]{48}$/.test(address)) {
            validation.className = 'validation-message validation-success';
            validation.innerHTML = '<i class="fas fa-check-circle"></i> Valid TON address';
        } else {
            validation.className = 'validation-message validation-error';
            validation.innerHTML = '<i class="fas fa-exclamation-circle"></i> TON address should start with UQ, EQ, or kQ and be 48 characters long';
        }
    };

    const validateFaucetPayEmail = () => {
        const email = document.getElementById('faucetpay-email').value.trim();
        const validation = document.getElementById('faucetpay-validation');
        
        if (email === '') {
            validation.className = 'validation-message validation-info';
            validation.innerHTML = '<i class="fas fa-info-circle"></i> Enter your FaucetPay registered email';
        } else if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            validation.className = 'validation-message validation-success';
            validation.innerHTML = '<i class="fas fa-check-circle"></i> Valid email format';
        } else {
            validation.className = 'validation-message validation-error';
            validation.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a valid email address';
        }
    };

    // ‚úÖ ÿØŸàÿßŸÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿ≠ÿ® ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
    const handleFaucetPayWithdrawal = async () => {
        const email = document.getElementById('faucetpay-email').value.trim();
        const amount = parseFloat(document.getElementById('withdraw-amount-faucetpay').value);
        
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Please enter a valid FaucetPay email address"); 
            }catch(e) {
                alert("‚ùå Please enter a valid FaucetPay email address");
            }
            return;
        }
        
        if (!amount || amount < 0.0001 || isNaN(amount)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Minimum withdrawal is 0.0001 TON"); 
            }catch(e) {
                alert("‚ùå Minimum withdrawal is 0.0001 TON");
            }
            return;
        }
        
        if (amount > (userState.balance || 0)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Insufficient TON balance"); 
            }catch(e) {
                alert("‚ùå Insufficient TON balance");
            }
            return;
        }

        const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
        const userReferrals = userState.referrals || 0;

        if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
            const message = `Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`;
            try{ 
                if (tg.showAlert) tg.showAlert(message); 
            }catch(e) {
                alert(message);
            }
            return;
        }

        const btn = document.getElementById('withdraw-faucetpay-btn'); 
        const originalText = btn.textContent;
        btn.disabled = true; 
        btn.textContent = 'üîÑ Processing...';
        
        try {
            console.log('üöÄ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≥ÿ≠ÿ® ÿ•ŸÑŸâ FaucetPay:', { amount, email });
            
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const withdrawResponse = await api.withdraw(initData, amount, email, 'FaucetPay');
            
            console.log('üì¶ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ≥ÿ≠ÿ®:', withdrawResponse);
            
            if (withdrawResponse.success) {
                userState.balance = withdrawResponse.newBalance;
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("‚úÖ Withdrawal request submitted successfully! It will be processed within 1 minute."); 
                }catch(e) {
                    alert("‚úÖ Withdrawal request submitted successfully!");
                }
                
                document.getElementById('faucetpay-email').value = '';
                document.getElementById('withdraw-amount-faucetpay').value = '';
                
                await loadWithdrawalHistory();
                renderUI();
                
            } else {
                let errorMessage = "Failed to submit withdrawal request.";
                if (withdrawResponse.error) {
                    errorMessage = withdrawResponse.error;
                } else if (withdrawResponse.message) {
                    errorMessage = withdrawResponse.message;
                }
                
                throw new Error(errorMessage);
            }
            
        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿ®:', error);
            
            let userMessage = "Failed to submit withdrawal request. Please try again.";
            
            if (error.message.includes('network') || error.message.includes('fetch')) {
                userMessage = "üåê Network error. Please check your connection and try again.";
            } else if (error.message.includes('balance') || error.message.includes('insufficient')) {
                userMessage = "üí∞ Insufficient balance for withdrawal.";
            } else if (error.message.includes('minimum')) {
                userMessage = "üìä Minimum withdrawal amount is 0.0001 TON.";
            } else if (error.message.includes('referral')) {
                userMessage = "üë• Referral requirement not met for withdrawal.";
            } else {
                userMessage = error.message || "Unknown error occurred.";
            }
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); 
                if (tg.showAlert) tg.showAlert(`‚ùå ${userMessage}`); 
            }catch(e) {
                alert(`‚ùå ${userMessage}`);
            }
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ÿßŸÑÿ≥ÿ≠ÿ® ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÄ TON
    const handleTONWithdrawal = async () => {
        const address = document.getElementById('ton-address').value.trim();
        const memo = document.getElementById('ton-memo').value.trim();
        const amount = parseFloat(document.getElementById('withdraw-amount-ton').value);
        
        if (!address || !/^(UQ|EQ|kQ)[a-zA-Z0-9_-]{48}$/.test(address)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Please enter a valid TON wallet address"); 
            }catch(e) {
                alert("‚ùå Please enter a valid TON wallet address");
            }
            return;
        }
        
        if (!amount || amount < 0.05 || isNaN(amount)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Minimum withdrawal is 0.05 TON"); 
            }catch(e) {
                alert("‚ùå Minimum withdrawal is 0.05 TON");
            }
            return;
        }
        
        if (amount > (userState.balance || 0)) {
            try{ 
                if (tg.showAlert) tg.showAlert("‚ùå Insufficient TON balance"); 
            }catch(e) {
                alert("‚ùå Insufficient TON balance");
            }
            return;
        }

        const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
        const userReferrals = userState.referrals || 0;

        if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
            const message = `Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`;
            try{ 
                if (tg.showAlert) tg.showAlert(message); 
            }catch(e) {
                alert(message);
            }
            return;
        }

        const btn = document.getElementById('withdraw-ton-btn'); 
        const originalText = btn.textContent;
        btn.disabled = true; 
        btn.textContent = 'üîÑ Processing...';
        
        try {
            console.log('üöÄ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≥ÿ≠ÿ®:', { amount, address, memo });
            
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const withdrawResponse = await api.withdraw(initData, amount, address, 'TON Wallet', memo);
            
            console.log('üì¶ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ≥ÿ≠ÿ®:', withdrawResponse);
            
            if (withdrawResponse.success) {
                userState.balance = withdrawResponse.newBalance;
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("‚úÖ Withdrawal request submitted successfully! It will be processed within 24 hours."); 
                }catch(e) {
                    alert("‚úÖ Withdrawal request submitted successfully!");
                }
                
                document.getElementById('ton-address').value = '';
                document.getElementById('ton-memo').value = '';
                document.getElementById('withdraw-amount-ton').value = '';
                
                await loadWithdrawalHistory();
                renderUI();
                
            } else {
                let errorMessage = "Failed to submit withdrawal request.";
                if (withdrawResponse.error) {
                    errorMessage = withdrawResponse.error;
                } else if (withdrawResponse.message) {
                    errorMessage = withdrawResponse.message;
                }
                
                throw new Error(errorMessage);
            }

        } catch (error) {
            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿ®:', error);
            
            let userMessage = "Failed to submit withdrawal request. Please try again.";
            
            if (error.message.includes('network') || error.message.includes('fetch')) {
                userMessage = "üåê Network error. Please check your connection and try again.";
            } else if (error.message.includes('balance') || error.message.includes('insufficient')) {
                userMessage = "üí∞ Insufficient balance for withdrawal.";
            } else if (error.message.includes('minimum')) {
                userMessage = "üìä Minimum withdrawal amount is 0.05 TON.";
            } else if (error.message.includes('referral')) {
                userMessage = "üë• Referral requirement not met for withdrawal.";
            } else {
                userMessage = error.message || "Unknown error occurred.";
            }
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error'); 
                if (tg.showAlert) tg.showAlert(`‚ùå ${userMessage}`); 
            }catch(e) {
                alert(`‚ùå ${userMessage}`);
            }
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    };

    const renderDynamicLinks = () => {
        const container = document.getElementById('dynamic-links-container'); 
        container.innerHTML = '';
        const defaultLinks = [
            {
                key: 'backup',
                name: 'Support üìû', 
                icon: 'https://img.icons8.com/ios-filled/100/customer-support.png',
                url: 'https://t.me/Elsayed_1_Elgohary'
            },
            {
                key: 'support', 
                name: 'Support üìû',
                icon: 'https://img.icons8.com/ios-filled/100/customer-support.png',
                url: 'https://t.me/aborabie777'
            },
            {
                key: 'giveaway',
                name: 'Payments Channel ',
                icon: 'https://img.icons8.com/ios-filled/100/confetti.png',
                url: 'https://t.me/earnmoney139482'
            }
        ];
        
        defaultLinks.forEach(link => {
            const el = document.createElement('div'); 
            el.className = 'task-container';
            el.innerHTML = `
                <img class="task-icon-img" src="${link.icon}" alt="icon">
                <div class="task-info">
                    <h3>${link.name}</h3>
                </div>
                <button class="action-btn" onclick="window.Telegram?.WebApp?.openLink ? window.Telegram.WebApp.openLink('${link.url}') : window.open('${link.url}','_blank')">
                    Visit
                </button>`;
            container.appendChild(el);
        });
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÉŸàÿØ
    const redeemCode = async () => {
        try {
            const codeInput = document.getElementById('redeem-code-input');
            const redeemBtn = document.getElementById('redeem-code-btn');
            
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Please enter a code!"); 
                }catch(e) {
                    alert("Please enter a code!");
                }
                return;
            }
            
            if (redeemedCodes.includes(code)) {
                try{ 
                    if (tg.showAlert) tg.showAlert("You have already used this code!"); 
                }catch(e) {
                    alert("You have already used this code!");
                }
                return;
            }
            
            redeemBtn.disabled = true;
            redeemBtn.textContent = 'Checking...';
            
            const validCodes = {
                'WELCOME100': { rewardValue: 10000, rewardType: 'RR' },
                'BONUS500': { rewardValue: 50000, rewardType: 'RR' },
                'START1000': { rewardValue: 100000, rewardType: 'RR' },
                'QWFP1234': { rewardValue: 0.001, rewardType: 'TON' },
                'PFWQ4321': { rewardValue: 5000, rewardType: 'RR' }
            };
            
            const codeData = validCodes[code];
            
            if (!codeData) {
                try{ 
                    if (tg.showAlert) tg.showAlert("Invalid code!"); 
                }catch(e) {
                    alert("Invalid code!");
                }
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'Redeem';
                return;
            }
            
            let successMessage = '';
            
            if (codeData.rewardType === 'TON') {
                const tonAmount = codeData.rewardValue || 0;
                userState.balance = (userState.balance || 0) + tonAmount;
                successMessage = `üéâ Code redeemed! You earned ${tonAmount.toFixed(4)} TON!`;
                saveUserState();
                
            } else if (codeData.rewardType === 'RR') {
                const rrAmount = codeData.rewardValue || 0;
                userRRBalance += rrAmount;
                localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                successMessage = `üéâ Code redeemed! You earned ${rrAmount.toLocaleString()} RR!`;
                
            } else {
                const points = codeData.rewardValue || 10;
                if (contestData.isActive) {
                    await awardContestPoints(points);
                    successMessage = `üéâ Code redeemed! You earned ${points} contest points!`;
                } else {
                    const rewardAmountRR = points * 100;
                    userRRBalance += rewardAmountRR;
                    localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
                    successMessage = `üéâ Code redeemed! You earned ${rewardAmountRR.toLocaleString()} RR!`;
                }
            }
            
            redeemedCodes.push(code);
            localStorage.setItem(`redeemedCodes_${tgUser.id || 'guest'}`, JSON.stringify(redeemedCodes));
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert(successMessage); 
            }catch(e) {
                alert(successMessage);
            }
            
            codeInput.value = '';
            redeemBtn.disabled = false;
            redeemBtn.textContent = 'Redeem';
            
            renderUI();
            
        } catch (error) {
            console.error('Error redeeming code:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("Failed to redeem code. Please try again."); 
            }catch(e) {
                alert("Failed to redeem code. Please try again.");
            }
            
            const redeemBtn = document.getElementById('redeem-code-btn');
            redeemBtn.disabled = false;
            redeemBtn.textContent = 'Redeem';
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÖŸÜÿ≠ ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const awardContestPoints = async (points) => {
        try {
            if (!contestData.isActive) {
                console.log('‚ÑπÔ∏è Contest is not active, skipping points award');
                return;
            }

            contestData.userPoints = (contestData.userPoints || 0) + points;
            localStorage.setItem(`contestData_${tgUser.id || 'guest'}`, JSON.stringify(contestData));
            
        } catch (error) {
            console.error('Error awarding contest points:', error);
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ŸÇÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const updateContestTimer = () => {
        const countdownEl = document.getElementById('contest-countdown');
        if (!contestData.endTime) {
            countdownEl.textContent = 'Contest not started';
            return;
        }
        
        const now = new Date().getTime();
        const distance = contestData.endTime - now;
        
        if (distance < 0) {
            countdownEl.textContent = 'Contest Ended!';
            contestData.isActive = false;
            updateContestStatus();
            return;
        }
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
    const updateContestStatus = () => {
        const statusBox = document.getElementById('contest-status-box');
        const statusValue = document.getElementById('contest-status-value');
        const statusMessage = document.getElementById('contest-status-message');
        
        if (!contestData.isActive) {
            statusBox.className = 'contest-status-box contest-status-ended';
            statusValue.textContent = 'Ended';
            statusMessage.textContent = 'The contest has ended. Check results soon!';
        } else {
            statusBox.className = 'contest-status-box contest-status-active';
            statusValue.textContent = 'Active';
            if (contestData.userRank > 0) {
                statusMessage.textContent = `You are currently ranked #${contestData.userRank} in the contest`;
            } else {
                statusMessage.textContent = 'Join the contest to start earning points!';
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const renderContestPage = () => {
        updateContestTimer();
        document.getElementById('user-contest-points').textContent = contestData.userPoints;
        document.getElementById('user-contest-rank').textContent = contestData.userRank > 0 ? `#${contestData.userRank}` : '-';
        renderCompactLeaderboard();
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿπÿ±ÿ∂ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ ÿßŸÑŸÖÿÆÿ™ÿµÿ±ÿ©
    const renderCompactLeaderboard = () => {
        const leaderboardList = document.getElementById('contest-leaderboard-compact-list');
        leaderboardList.innerHTML = '';
        
        if (contestData.leaderboard.length === 0) {
            leaderboardList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary-dark);">No participants yet. Be the first to join!</p>';
            return;
        }
        
        const top10 = contestData.leaderboard.slice(0, 10);
        
        top10.forEach((participant, index) => {
            const rank = index + 1;
            const isCurrentUser = participant.user_id === tgUser.id;
            
            let rankIcon = rank;
            if (rank === 1) rankIcon = 'ü•á';
            else if (rank === 2) rankIcon = 'ü•à';
            else if (rank === 3) rankIcon = 'ü•â';
            
            let displayName = 'Unknown User';
            if (participant.first_name && participant.first_name.trim() !== '') {
                displayName = participant.first_name;
            } else if (participant.username) {
                displayName = `@${participant.username}`;
            } else if (participant.user_id) {
                displayName = `User ${participant.user_id}`;
            }
            
            const prizeAmount = getPrizeForRank(rank);
            const prizeText = prizeAmount > 0 ? `${prizeAmount} TON` : '';
            
            const item = document.createElement('div');
            item.className = `contest-leaderboard-item-compact ${isCurrentUser ? 'current-user' : ''}`;
            item.innerHTML = `
                <div class="contest-rank-compact ${rank <= 3 ? 'top-3' : ''}">
                    ${rankIcon}
                </div>
                <div class="contest-user-info-compact" style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                    <div class="contest-user-details">
                        <div class="contest-user-name-compact">${displayName}</div>
                        <div class="contest-user-points-compact">${participant.points || 0} points</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="contest-user-score-compact">${participant.points || 0}</div>
                        ${prizeText ? `<div class="contest-user-prize">${prizeText}</div>` : ''}
                    </div>
                </div>
            `;
            leaderboardList.appendChild(item);
        });
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇŸäŸÖÿ© ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÖÿ±ŸÉÿ≤
    const getPrizeForRank = (rank) => {
        const prizes = {
            1: 0.6,
            2: 0.4,
            3: 0.3,
            4: 0.15,
            5: 0.15,
            6: 0.1,
            7: 0.1,
            8: 0.1,
            9: 0.05,
            10: 0.05
        };
        
        return prizes[rank] || 0;
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©
    window.showFullLeaderboard = () => {
        showPopup(`
            <div style="text-align: left; max-height: 70vh; overflow-y: auto;">
                <h2 style="margin-bottom: 15px; color: var(--ship-gold);">üèÜ Full Leaderboard</h2>
                <div style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-secondary-dark);">
                    Showing top 50 participants
                </div>
                <div id="full-leaderboard-content">
                    ${generateFullLeaderboardHTML()}
                </div>
                <button class="popup-close-btn" onclick="closePopup()" style="margin-top: 15px; width: 100%;">Close</button>
            </div>
        `);
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ŸàŸÑŸäÿØ HTML ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑÿ©
    const generateFullLeaderboardHTML = () => {
        if (contestData.leaderboard.length === 0) {
            return '<p style="text-align: center; padding: 20px;">No participants yet.</p>';
        }
        
        let html = '';
        const top50 = contestData.leaderboard.slice(0, 50);
        
        top50.forEach((participant, index) => {
            const rank = index + 1;
            const isCurrentUser = participant.user_id === tgUser.id;
            const prizeAmount = getPrizeForRank(rank);
            const prizeText = prizeAmount > 0 ? `${prizeAmount} TON` : '';
            
            let displayName = 'Unknown User';
            if (participant.first_name && participant.first_name.trim() !== '') {
                displayName = participant.first_name;
            } else if (participant.username) {
                displayName = `@${participant.username}`;
            } else if (participant.user_id) {
                displayName = `User ${participant.user_id}`;
            }
            
            let rankIcon = rank;
            if (rank === 1) rankIcon = 'ü•á';
            else if (rank === 2) rankIcon = 'ü•à';
            else if (rank === 3) rankIcon = 'ü•â';
            
            html += `
                <div style="display: flex; align-items: center; padding: 10px; margin: 5px 0; border-radius: 8px; ${
                    isCurrentUser ? 'background: rgba(255, 215, 0, 0.1); border: 2px solid var(--ship-gold);' : 'background: rgba(255,255,255,0.05);'
                }">
                    <div style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(45deg, var(--ship-gold), #ffa500); 
                         display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; margin-right: 12px; font-size: 0.9rem;">
                        ${rankIcon}
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600; ${isCurrentUser ? 'color: var(--ship-gold);' : ''}">${displayName}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary-dark);">${participant.points || 0} points ‚Ä¢ ${participant.ads_watched || 0} ads ‚Ä¢ ${participant.referrals_count || 0} referrals</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--ship-gold);">${participant.points || 0}</div>
                        ${prizeText ? `<div style="font-size: 0.75rem; color: var(--success); margin-top: 2px;">${prizeText}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        return html;
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸäŸàŸÖŸä
    window.claimDailyLoginBonus = async () => {
        try {
            const today = new Date().toDateString();
            
            if (dailyLoginData.claimedDays && dailyLoginData.claimedDays.includes(today)) {
                try{ 
                    if (tg.showAlert) tg.showAlert("You have already claimed your daily bonus today!"); 
                }catch(e) {
                    alert("You have already claimed your daily bonus today!");
                }
                return;
            }
            
            const currentStreak = dailyLoginData.currentStreak || 1;
            const rewardIndex = Math.min(currentStreak - 1, dailyLoginRewards.length - 1);
            const rewardAmount = dailyLoginRewards[rewardIndex] || dailyLoginRewards[dailyLoginRewards.length - 1] || 0.0001;
            
            const rewardAmountRR = Math.round(rewardAmount * RR_TO_TON_RATE);
            userRRBalance += rewardAmountRR;
            localStorage.setItem(`userRRBalance_${tgUser.id || 'guest'}`, userRRBalance.toString());
            
            if (!dailyLoginData.claimedDays) {
                dailyLoginData.claimedDays = [];
            }
            dailyLoginData.claimedDays.push(today);
            dailyLoginData.lastLoginDate = today;
            
            localStorage.setItem(`dailyLoginData_${tgUser.id || 'guest'}`, JSON.stringify(dailyLoginData));
            
            try{ 
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                if (tg.showAlert) tg.showAlert(`üéâ Daily login bonus claimed! +${rewardAmountRR.toLocaleString()} RR (Day ${currentStreak})`); 
            }catch(e) {
                alert(`üéâ Daily login bonus claimed! +${rewardAmountRR.toLocaleString()} RR (Day ${currentStreak})`);
            }
            
            renderUI();
            
            setTimeout(() => {
                closeDailyCalendar();
            }, 1500);
            
        } catch (error) {
            console.error('Error claiming daily login bonus:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("Failed to claim daily bonus. Please try again."); 
            }catch(e) {
                alert("Failed to claim daily bonus. Please try again.");
            }
        }
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸäŸàŸÖŸä ÿßŸÑŸÖÿπÿØŸÑÿ©
    window.openDailyCalendar = () => {
        const today = new Date().toDateString();
        const isClaimedToday = dailyLoginData.claimedDays && dailyLoginData.claimedDays.includes(today);
        const currentStreak = dailyLoginData.currentStreak || 1;
        
        let calendarHTML = '';
        for (let day = 1; day <= dailyLoginRewards.length; day++) {
            const rewardAmount = dailyLoginRewards[day - 1];
            const rewardAmountRR = Math.round(rewardAmount * RR_TO_TON_RATE);
            let dayClass = 'calendar-day-compact future';
            let statusText = 'Future';
            
            if (day < currentStreak) {
                dayClass = 'calendar-day-compact completed';
                statusText = 'Claimed';
            } else if (day === currentStreak) {
                if (isClaimedToday) {
                    dayClass = 'calendar-day-compact completed';
                    statusText = 'Claimed';
                } else {
                    dayClass = 'calendar-day-compact current';
                    statusText = 'Claim Now';
                }
            }
            
            calendarHTML += `
                <div class="${dayClass}">
                    <div class="day-number-compact">Day ${day}</div>
                    <div class="day-reward-compact">${rewardAmountRR.toLocaleString()} RR</div>
                    <div class="day-status-compact">${statusText}</div>
                </div>
            `;
        }
        
        document.getElementById('streak-calendar-compact').innerHTML = calendarHTML;
        document.getElementById('current-streak-display').textContent = `${currentStreak} days`;
        
        const statusElement = document.getElementById('daily-login-status');
        if (isClaimedToday) {
            statusElement.innerHTML = `
                <div style="color: var(--success);">
                    <i class="fas fa-check-circle"></i> Today's bonus already claimed!
                </div>
            `;
        } else {
            statusElement.innerHTML = `
                <div style="color: var(--ship-gold);">
                    <i class="fas fa-gift"></i> Today's bonus available! 
                    <button onclick="claimDailyLoginBonus()" class="action-btn" style="padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;">
                        Claim Now
                    </button>
                </div>
            `;
        }
        
        document.getElementById('daily-calendar-popup').style.display = 'flex';
    };

    // ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸäŸàŸÖŸä
    window.closeDailyCalendar = () => {
        document.getElementById('daily-calendar-popup').style.display = 'none';
    };

    // üí∞ ÿØÿßŸÑÿ© ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
    const moveToBalance = async () => {
        try {
            const initData = tg.initDataUnsafe?.query_id ? tg.initData : (tg.initData || '');
            const moveResponse = await api.moveToBalance(initData);
            
            if (moveResponse.success) {
                userState.balance = moveResponse.newBalance;
                earningWalletBalance = moveResponse.earningWallet;
                
                try{ 
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); 
                    if (tg.showAlert) tg.showAlert("ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠!"); 
                }catch(e) {
                    alert("ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠!");
                }
                
                renderUI();
            } else {
                throw new Error(moveResponse.error);
            }
        } catch (error) {
            console.error('Error moving to balance:', error);
            try{ 
                if (tg.showAlert) tg.showAlert("ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ"); 
            }catch(e) {
                alert("ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ");
            }
        }
    };

    // üõë ÿ•ŸäŸÇÿßŸÅ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©
    window.addEventListener('beforeunload', () => {
        if (tokenRefreshInterval) {
            clearInterval(tokenRefreshInterval);
        }
    });

    // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    initApp();
});

// ÿ•ÿ∂ÿßŸÅÿ© keyframes ŸÑŸÑŸÄ spinner
(function addSpinKeyframes(){ 
    const style = document.createElement('style'); 
    style.innerHTML='@keyframes spin{to{transform:rotate(360deg)}}'; 
    document.head.appendChild(style); 
})();
</script>
</body>
</html>
